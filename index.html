<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Nutrición Parenteral Hospitalaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .criterion-check:checked + div { background-color: #fff7ed; border-color: #f97316; color: #c2410c; }
        
        /* Tab Styles Redesigned */
        .tab-btn { 
            @apply px-6 py-3 font-bold text-sm rounded-xl transition-all duration-200 flex items-center justify-center gap-2; 
        }
        .tab-btn.active { 
            @apply bg-slate-50 text-blue-700 shadow-md transform scale-105; 
        }
        .tab-btn.inactive { 
            @apply text-blue-100 hover:bg-white/10 hover:text-white border border-transparent; 
        }

        /* =========================================================
       ESTILOS DE IMPRESIÓN MEJORADOS (SIN CORTES BRUSCOS)
       ========================================================= */
    @media print {
        @page {
            margin: 1cm;
            size: A4 portrait;
        }

        /* Ocultar interfaz */
        body > *:not(#printable-area) {
            display: none !important;
        }

        /* Mostrar reporte */
        #printable-area {
            display: block !important;
            font-family: 'Inter', sans-serif;
            color: black;
            font-size: 11pt;
            line-height: 1.3;
            width: 100%;
        }

        /* BLOQUES PRINCIPALES: Evita que se corten por la mitad */
        /* 1. Sección con menos margen */
        .print-section { 
            margin-bottom: 10px; /* Antes era 20px */
            border-bottom: 1px solid #ddd; 
            padding-bottom: 8px; /* Antes era 15px */
            break-inside: avoid;      
            page-break-inside: avoid; 
        }

        .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* TABLAS */
        .print-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 10pt; }
        
        .print-table th { 
            background-color: #f0f0f0 !important; /* Forzar fondo gris en impresión */
            -webkit-print-color-adjust: exact;    /* Para Chrome/Safari */
            print-color-adjust: exact;            /* Para Firefox */
            font-weight: bold; 
            text-align: left; 
            padding: 5px; 
            border-bottom: 2px solid #333; 
        }
        
        /* 3. Filas de tabla más finas */
        .print-table td { 
            padding: 2px 4px; /* Antes era 5px */
            border-bottom: 1px solid #eee; 
        }
        
        /* Evitar que una fila de la tabla se corte por la mitad */
        .print-table tr {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* Títulos siempre pegados a su contenido */
        h3, h4 {
            break-after: avoid;
            page-break-after: avoid;
        }

        /* Estilos de texto */
        .print-title { font-size: 20pt; font-weight: bold; color: #1e3a8a; margin-bottom: 5px; }
        .print-subtitle { font-size: 10pt; color: #666; margin-bottom: 25px; }
        /* 2. Cabecera con menos altura */
        .print-header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            border-bottom: 3px solid #1e3a8a; 
            padding-bottom: 5px; /* Antes era 15px */
            margin-bottom: 10px; /* Antes era 25px */
        }
        
        .box-highlight { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; }
        .info-label { font-size: 9pt; color: #64748b; text-transform: uppercase; font-weight: 700; }
        .info-value { font-size: 11pt; font-weight: 600; color: #0f172a; }
        }

        /* PÁGINA DE ETIQUETAS (Hoja 3) */
        #labels-page-content {
            page-break-before: always;
            break-before: page;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            height: 24cm; 
            width: 100%;
            gap: 1cm;
            padding-top: 0.5cm;
        }

        /* DISEÑO DE CADA ETIQUETA (Tipo Informe) */
        .label-report {
            font-family: 'Arial', sans-serif;
            font-size: 8pt; 
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px dashed #ccc; 
            padding: 10px;
            box-sizing: border-box;
        }

        .lbl-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 4px; margin-bottom: 8px; }
        .lbl-title { font-weight: bold; font-size: 11pt; color: #000; }
        .lbl-subtitle { font-size: 7pt; color: #555; text-transform: uppercase; margin-top: 2px; }

        .lbl-patient-row { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 4px; margin-bottom: 8px; font-weight: bold; font-size: 9pt; }

        .lbl-data-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        .lbl-data-table th { background: #eee; font-weight: bold; text-align: left; padding: 2px 4px; border: 1px solid #999; font-size: 7pt; }
        .lbl-data-table td { border: 1px solid #ccc; padding: 2px 4px; font-size: 8pt; }
        .lbl-val-bold { font-weight: bold; color: #000; }

        .lbl-footer { margin-top: auto; text-align: center; font-size: 7pt; color: #666; border-top: 1px solid #ccc; padding-top: 4px; }
        .lbl-box-osm { border: 1px solid #000; padding: 3px; text-align: center; background: #f9fafb; }
        .lbl-via { font-weight: bold; font-size: 10pt; display: block; }

    }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

     <div class="hidden print-header p-4 mb-4">
         <h1 class="text-2xl font-bold text-slate-800">INFORME DE NUTRICIÓN PARENTERAL</h1>
         <p class="text-sm text-slate-500">Generado por NutriCalc Hospitalaria</p>
         <div class="text-xs text-slate-400 mt-1" id="print-date"></div>
    </div>
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white shadow-xl sticky top-0 z-50 transition-all">
        <div class="max-w-7xl mx-auto px-2 py-2 md:px-4 md:py-3">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-3 lg:gap-8">
                
                <div class="flex items-center space-x-3 w-full lg:w-auto justify-center lg:justify-start">
                    <div class="bg-white p-2 rounded-xl shadow-lg flex-shrink-0">
                        <svg class="w-8 h-8 md:w-10 md:h-10" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#2563EB" />
                            <rect x="35" y="20" width="30" height="60" rx="5" fill="white" />
                            <rect x="20" y="35" width="60" height="30" rx="5" fill="white" />
                            <path d="M50 50 C 50 50, 70 20, 90 30 C 90 30, 80 70, 50 50" fill="#4ADE80" stroke="#166534" stroke-width="2"/>
                            <path d="M50 50 L 80 40" stroke="#166534" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-bold tracking-tight text-white leading-tight">NutriCalc Hospitalaria</h1>
                        <p class="text-[10px] md:text-xs text-blue-100 font-medium opacity-90 tracking-wide">Protocolo UCI & Planta según ESPEN</p>
                    </div>
                </div>

                <div class="w-full lg:w-auto overflow-x-auto pb-1 lg:pb-0 no-scrollbar">
                    <div class="flex space-x-2 md:space-x-3 bg-blue-900/30 p-1.5 rounded-2xl min-w-max mx-auto lg:mx-0">
                        
                        <button onclick="switchTab('calculadora')" id="tab-calc" class="tab-btn active min-w-[110px] md:min-w-[140px] px-4 py-2 md:px-6 md:py-3 text-xs md:text-sm">
                            <i class="fa-solid fa-calculator text-sm md:text-base"></i>
                            <span>Calculadora</span>
                        </button>

                        <button onclick="switchTab('elaboracion')" id="tab-elab" class="tab-btn inactive min-w-[110px] md:min-w-[140px] px-4 py-2 md:px-6 md:py-3 text-xs md:text-sm">
                            <i class="fa-solid fa-flask text-sm md:text-base"></i>
                            <span>Elaboración</span>
                        </button>

                        <button onclick="switchTab('bibliografia')" id="tab-biblio" class="tab-btn inactive min-w-[100px] md:min-w-[130px] px-4 py-2 md:px-6 md:py-3 text-xs md:text-sm">
                            <i class="fa-solid fa-book-medical text-sm md:text-base"></i>
                            <span>Bibliografía</span>
                        </button>
                        
                        <button onclick="switchTab('config')" id="tab-config" class="tab-btn inactive min-w-[100px] md:min-w-[130px] px-4 py-2 md:px-6 md:py-3 text-xs md:text-sm">
                            <i class="fa-solid fa-database text-sm md:text-base"></i>
                            <span>Configuración</span>
                        </button>

                    </div>
                </div>

                <div class="flex-shrink-0 w-full lg:w-auto mt-2 lg:mt-0">
                    <button onclick="prepareAndPrint()" class="w-full lg:w-auto justify-center bg-white/10 hover:bg-white/20 border border-white/30 px-5 py-2.5 rounded-xl text-xs font-bold transition flex items-center gap-2 backdrop-blur-sm">
                           <i class="fa-solid fa-print"></i> 
                           <span>INFORME</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-2 py-4 md:px-4 md:py-8 flex-grow w-full">
        
        <div id="view-calculadora" class="grid grid-cols-1 lg:grid-cols-12 gap-8 slide-in">
            
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-blue-800 border-b pb-2"><i class="fa-solid fa-user-injured mr-2"></i>Datos del Paciente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-600 mb-1">Nombre Completo del Paciente</label>
                            <input type="text" id="nombre-paciente" class="w-full border-slate-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 font-bold text-slate-800" placeholder="Nombre y Apellidos">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">NHC</label>
                            <input type="text" id="nhc" class="w-full border-slate-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Hist. Clínica">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Cama</label>
                            <input type="text" id="cama" class="w-full border-slate-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" placeholder="Nº Cama">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Sexo</label>
                            <select id="sexo" class="w-full border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                <option value="hombre">Hombre</option>
                                <option value="mujer">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Edad (años)</label>
                            <input type="number" id="edad" class="w-full border-slate-300 rounded-md shadow-sm p-2 border" placeholder="Ej. 65">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Peso (kg)</label>
                            <input type="number" id="peso" onchange="checkIMC()" class="w-full border-slate-300 rounded-md shadow-sm p-2 border" placeholder="Ej. 75">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Altura (cm)</label>
                            <input type="number" id="altura" onchange="checkIMC()" class="w-full border-slate-300 rounded-md shadow-sm p-2 border" placeholder="Ej. 175">
                        </div>
                    </div>
                    <div id="imc-preview" class="mt-2 text-xs font-bold text-slate-500 text-right">IMC: --</div>
                </div>

                <div class="bg-orange-50 p-6 rounded-xl shadow-sm border border-orange-100">
                    <h2 class="text-lg font-semibold mb-3 text-orange-800 border-b border-orange-200 pb-2 flex justify-between">
                        <span><i class="fa-solid fa-notes-medical mr-2"></i>Riesgo Realimentación</span>
                        <span id="risk-badge" class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded">Evaluando...</span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white/50 p-3 rounded border border-orange-100">
                            <h4 class="text-xs font-bold text-orange-700 uppercase mb-2">Criterios Moderados (2+)</h4>
                            <div class="space-y-2 text-xs">
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="mod-weight" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Pérdida 5% (1 mes)</span>
                                </label>
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="mod-fasting" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Ayuno 5-6 días</span>
                                </label>
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="mod-intake" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Ingesta <75% (>7 días)</span>
                                </label>
                                <div id="mod-imc-check" class="flex items-center text-slate-400">
                                    <i class="fa-regular fa-square mr-2"></i> IMC 16 - 18 kg/m²
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/50 p-3 rounded border border-red-100">
                            <h4 class="text-xs font-bold text-red-700 uppercase mb-2">Criterios Severos (1+)</h4>
                            <div class="space-y-2 text-xs">
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="sev-weight" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Pérdida >7.5% (3m) o >10% (6m)</span>
                                </label>
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="sev-fasting" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Ayuno >7 días</span>
                                </label>
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="sev-intake" class="mt-0.5 mr-2 criterion-check" onchange="evaluateRisk()">
                                    <span>Ingesta <50% (>5 días)</span>
                                </label>
                                <div id="sev-imc-check" class="flex items-center text-slate-400">
                                    <i class="fa-regular fa-square mr-2"></i> IMC < 16 kg/m²
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="refeeding-options" class="hidden mt-4 pt-4 border-t border-orange-200">
                    <div class="flex flex-row flex-nowrap items-center gap-3">
                        <div class="flex-shrink-0 text-orange-800 font-bold text-sm whitespace-nowrap">
                            <i class="fa-solid fa-calendar-days mr-2"></i>Fase de Realimentación:
                        </div>
                        
                        <select id="refeeding-phase" class="flex-grow w-full min-w-0 border-orange-300 rounded-md text-sm p-2 bg-white text-orange-900 font-medium focus:ring-orange-500 focus:border-orange-500 shadow-sm" onchange="calcular()">
                            <option value="0.25">Días 1 - 4: 25% del GET</option>
                            <option value="0.60">Días 5 - 7: 60% del GET</option>
                            <option value="1.0">Día 8 en adelante: 100% del GET</option>
                        </select>
                    </div>
                    
                    <div class="mt-2 text-[10px] text-orange-700 bg-orange-100 p-2 rounded border border-orange-200">
                        <i class="fa-solid fa-lock mr-1"></i> <strong>Protocolo de Seguridad Activado:</strong> Reparto fijo 50% HC / 30% Lípidos / 20% Proteínas sobre las calorías ajustadas.
                    </div>
                </div>

            </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-blue-800 border-b pb-2"><i class="fa-solid fa-hospital mr-2"></i>Ubicación y Protocolo</h2>
                    
                    <div class="flex space-x-4 mb-4">
                        <button onclick="setMode('uci')" id="btn-uci" class="flex-1 py-2 rounded-lg font-medium border-2 border-blue-600 bg-blue-600 text-white transition">UCI / Críticos</button>
                        <button onclick="setMode('planta')" id="btn-planta" class="flex-1 py-2 rounded-lg font-medium border-2 border-slate-200 text-slate-600 hover:border-blue-400 transition">Planta / No UCI</button>
                    </div>

                    <div id="uci-fields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Tipo de Paciente UCI</label>
                            <select id="uci-tipo" class="w-full border-slate-300 rounded-md shadow-sm p-2 border">
                                <option value="normal">UCI Normal</option>
                                <option value="sepsis">Sepsis</option>
                                <option value="hepatico">Insuficiencia Hepática Grave</option>
                                <option value="fistula">Fístula Alto Débito / Abd. Abierto</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Fase / Días con NP</label>
                                <select id="uci-dias" class="w-full border-slate-300 rounded-md shadow-sm p-2 border">
                                    <option value="aguda">Fase Aguda (1-5 días)</option>
                                    <option value="estable">Fase Estable (>5 días)</option>
                                    <option value="recuperacion">Recuperación (>10 días)</option>
                                </select>
                            </div>
                            <div class="flex items-center mt-6">
                                <input type="checkbox" id="vent-mec" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="vent-mec" class="ml-2 block text-sm text-gray-900">Ventilación Mecánica</label>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                            <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Aportes Externos (Resta automática)</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600">Propofol (ml/día)</label>
                                    <input type="number" id="propofol" class="w-full text-sm border-slate-300 rounded-md p-1 border" placeholder="0">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600">Citrato (mmol/día)</label>
                                    <input type="number" id="citrato" class="w-full text-sm border-slate-300 rounded-md p-1 border" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="planta-fields" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Nivel Estrés</label>
                                <select id="planta-estres" class="w-full border-slate-300 rounded-md shadow-sm p-2 border">
                                    <option value="leve">Leve (Post-cirugía)</option>
                                    <option value="moderado">Moderado (Infección)</option>
                                    <option value="intenso">Intenso (Fallo orgánico)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Actividad</label>
                                <select id="planta-actividad" class="w-full border-slate-300 rounded-md shadow-sm p-2 border">
                                    <option value="1.0">Reposo</option>
                                    <option value="1.2">Cama/Sillón</option>
                                    <option value="1.3">Ambulación</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t">
                        <label class="block text-sm font-bold text-slate-700 mb-2">
                            <i class="fa-solid fa-chart-pie mr-2 text-blue-500"></i>Relación HC / Lípidos (Kcal no proteicas)
                        </label>
                        <select id="ratio-hc-lip" class="w-full border-slate-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 bg-yellow-50/50">
                            <option value="70">70% HC / 30% Lípidos</option>
                            <option value="60" selected>60% HC / 40% Lípidos</option>
                            <option value="50">50% HC / 50% Lípidos</option>
                            <option value="40">40% HC / 60% Lípidos</option>
                        </select>
                    </div>

                    <div class="mt-4 pt-4 border-t border-dashed">
                        <h4 class="text-sm font-bold text-slate-700 mb-3"><i class="fa-solid fa-faucet-drip mr-2 text-blue-500"></i>Balance Hídrico (Opcional)</h4>
                        <div class="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Diuresis (ml)</label>
                                <input type="number" id="diuresis" class="w-full text-sm border-slate-300 rounded-md p-1.5 border focus:ring-1 focus:ring-blue-500" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1">Sueroterapia (ml)</label>
                                <input type="number" id="suero" class="w-full text-sm border-slate-300 rounded-md p-1.5 border focus:ring-1 focus:ring-blue-500" placeholder="0">
                            </div>
                            <div class="col-span-2">
                                <p class="text-[10px] text-slate-400 text-center">Prioridad: Diuresis > Suero > Peso</p>
                            </div>
                        </div>
                    </div>

                </div>

                <button onclick="calcular()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition transform hover:scale-[1.01]">
                    CALCULAR REQUERIMIENTOS
                </button>
            </div>

            <div class="lg:col-span-7 space-y-6">
                
                <div id="results-container" class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 min-h-[500px] flex flex-col justify-center items-center text-slate-400">
                    <i class="fa-solid fa-calculator text-4xl mb-4"></i>
                    <p>Introduce los datos y pulsa Calcular</p>
                </div>
                
                <div id="results-content" class="hidden space-y-6 slide-in">
                    
                    <div id="alerts-box" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
                        <div class="flex">
                            <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-red-500"></i></div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Alerta de Seguridad</h3>
                                <div id="alerts-text" class="mt-2 text-sm text-red-700"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center text-sm">
                        <div><span class="font-semibold">IMC:</span> <span id="res-imc">--</span></div>
                        <div><span class="font-semibold">Peso Ideal:</span> <span id="res-ibw">--</span> kg</div>
                        <div><span class="font-semibold">Peso Cálculo:</span> <span id="res-calc-weight" class="text-blue-600 font-bold">--</span> kg</div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
                        <div class="bg-slate-800 text-white px-6 py-3 flex justify-between items-center">
                            <h3 class="font-bold">Prescripción de Macronutrientes</h3>
                            <div class="text-right">
                                <span id="total-kcal" class="bg-blue-500 px-3 py-1 rounded text-sm font-bold block">0 kcal/día</span>
                                <span id="kcal-type-label" class="text-[10px] text-blue-200 uppercase font-bold">Total</span>
                            </div>
                        </div>
                        
                        <div class="p-6 grid gap-6">
                            <div class="flex items-center justify-between border-b pb-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 mr-4"><i class="fa-solid fa-drumstick-bite"></i></div>
                                    <div>
                                        <h4 class="font-bold text-slate-700">Proteínas (Aminoácidos)</h4>
                                        <p class="text-xs text-slate-500" id="prot-target">Target: -- g/kg</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-slate-800">
                                        <span id="val-prot">0</span> <span class="text-sm font-normal text-slate-600">g aa</span> / 
                                        <span id="val-n2">0</span> <span class="text-sm font-normal text-slate-600">g N</span>
                                    </div>
                                    <div class="text-xs text-slate-500"><span id="kcal-prot">0</span> kcal</div>
                                    <div class="text-[10px] text-blue-600 font-bold mt-1" title="Relación Kcal No Proteicas / g N">Relación Kcal No Proteicas / g N: <span id="calc-ratio-npcn">0</span></div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between border-b pb-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-4"><i class="fa-solid fa-bread-slice"></i></div>
                                    <div>
                                        <h4 class="font-bold text-slate-700">Hidratos de Carbono</h4>
                                        <p class="text-xs text-slate-500" id="hc-ratio-display">Glucosa</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-slate-800"><span id="val-hc">0</span> g</div>
                                    <div class="text-xs text-slate-500"><span id="kcal-hc">0</span> kcal</div>
                                    <div id="citrato-warning" class="text-[10px] text-orange-600 hidden font-bold">Ajustado por Citrato (-<span id="val-citrato-kcal">0</span> kcal)</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 mr-4"><i class="fa-solid fa-oil-can"></i></div>
                                    <div>
                                        <h4 class="font-bold text-slate-700">Lípidos</h4>
                                        <p class="text-xs text-slate-500" id="lip-ratio-display">Emulsión lipídica</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-slate-800"><span id="val-lip">0</span> g</div>
                                    <div class="text-xs text-slate-500"><span id="kcal-lip">0</span> kcal (Bolsa)</div>
                                    <div id="propofol-warning" class="text-[10px] text-orange-600 hidden font-bold">Ajustado por Propofol (-<span id="val-propofol-lip">0</span>g)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h4 class="font-bold text-slate-700 mb-3 border-b pb-2">Electrolitos (Rango Total)</h4>
                            <ul class="space-y-2 text-sm" id="electro-list">
                                </ul>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h4 class="font-bold text-slate-700 mb-3 border-b pb-2">Aditivos Diarios</h4>
                            <ul class="space-y-3 text-sm text-slate-600">
                                <li class="flex flex-col border-b border-slate-50 pb-2">
                                    <span class="font-bold text-slate-700">Multivitamínicos (Soluvit + Vitalipid)</span>
                                    <span class="text-xs text-slate-500 mt-1 pl-2 border-l-2 border-slate-200">1 ampolla de cada (10ml c/u)</span>
                                </li>
                                <li class="flex flex-col border-b border-slate-50 pb-2">
                                    <span class="font-bold text-slate-700">Oligoelementos (Oligostandard)</span>
                                    <span class="text-xs text-slate-500 mt-1 pl-2 border-l-2 border-slate-200">1 ampolla (10ml)</span>
                                </li>
                                <li class="flex flex-col border-b border-slate-50 pb-2">
                                    <span class="font-bold text-slate-700">Tiamina</span>
                                    <span class="text-xs font-bold text-blue-600 mt-1 pl-2 border-l-2 border-blue-100" id="val-tiamina">3 mg</span>
                                </li>
                                <li id="li-insulina" class="flex flex-col hidden bg-yellow-50 p-2 rounded">
                                    <span class="font-bold text-slate-700">Insulina (Regla 160g=16UI)</span>
                                    <span class="text-xs font-bold mt-1 pl-2 border-l-2 border-yellow-200" id="val-insulina">--</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center">
                        <h4 class="text-blue-800 font-bold mb-3">Volumen Líquido a Administrar</h4>
                        <div class="flex flex-col items-center justify-center gap-2">
                            <div class="text-xs text-blue-600 bg-blue-100 px-3 py-1 rounded-full border border-blue-200">
                                Sugerido: <span id="val-volumen-sugerido" class="font-bold">--</span> ml
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="number" id="volumen-administrar" class="w-32 text-center text-xl font-bold text-blue-700 border-2 border-blue-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white" placeholder="0" onchange="calculateCompounding()">
                                <span class="text-sm font-bold text-blue-600">ml</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-blue-400 mt-2" id="vol-formula">Cálculo basado en diuresis o estimado</p>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-elaboracion" class="hidden slide-in max-w-4xl mx-auto">
            
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-8">
                <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold"><i class="fa-solid fa-file-prescription mr-2"></i>Ficha de Elaboración</h2>
                    <span class="text-xs bg-blue-600 px-2 py-1 rounded">Resumen de Requerimientos</span>
                </div>
                
                <div class="p-8 space-y-8">
                    <div id="elaboracion-empty" class="text-center text-slate-400 py-10">
                        <i class="fa-solid fa-calculator text-4xl mb-4"></i>
                        <p>Por favor, realice el cálculo en la pestaña "Calculadora" primero.</p>
                    </div>

                    <div id="elaboracion-content" class="hidden">
                        <div class="mb-8">
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2 mb-4">1. Macronutrientes</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="bg-red-50 p-4 rounded-lg border border-red-100 flex flex-col justify-center items-center">
                                    <div class="text-red-600 font-bold mb-1">Proteínas / Nitrógeno</div>
                                    <div class="text-xl font-bold text-slate-800 text-center" id="elab-prot">0</div>
                                    <div class="mt-2 text-xs text-slate-500 text-center border-t border-red-100 pt-1 w-full">
                                        <div class="font-semibold"><span id="elab-kcal-prot">0</span> kcal</div>
                                        <div class="text-[10px] text-slate-600 mt-1" title="Kcal No Proteicas / g N">Kcal No Proteicas / g N: <span id="elab-ratio-npcn" class="font-bold text-red-700">0</span></div>
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                    <div class="text-blue-600 font-bold mb-1">H. Carbono</div>
                                    <div class="text-2xl font-bold text-slate-800" id="elab-hc">0</div>
                                    <div class="text-xs text-slate-500">gramos</div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                                    <div class="text-yellow-600 font-bold mb-1">Lípidos</div>
                                    <div class="text-2xl font-bold text-slate-800" id="elab-lip">0</div>
                                    <div class="text-xs text-slate-500">gramos</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-8">
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2 mb-4">2. Electrolitos</h3>
                            <div class="bg-slate-50 rounded-lg border border-slate-200 p-4">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-left text-slate-400 text-xs">
                                            <th class="pb-2">Electrolito</th>
                                            <th class="pb-2 text-right">Dosis Prescrita</th>
                                        </tr>
                                    </thead>
                                    <tbody id="elab-electro-list" class="divide-y divide-slate-200">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mb-8">
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2 mb-4">3. Aditivos</h3>
                            <div class="bg-white border border-slate-200 rounded-lg divide-y divide-slate-100">
                                <div class="p-3 flex justify-between">
                                    <span class="font-medium text-slate-700">Multivitamínicos</span>
                                    <span class="text-slate-600">Soluvit N + Vitalipid N (1 vial c/u)</span>
                                </div>
                                <div class="p-3 flex justify-between">
                                    <span class="font-medium text-slate-700">Oligoelementos</span>
                                    <span class="text-slate-600">Oligostandard (1 ampolla)</span>
                                </div>
                                <div class="p-3 flex justify-between">
                                    <span class="font-medium text-slate-700">Tiamina</span>
                                    <span class="font-bold text-blue-600" id="elab-tiamina">3 mg</span>
                                </div>
                                <div class="p-3 flex justify-between hidden" id="elab-insulina-row">
                                    <span class="font-medium text-slate-700">Insulina</span>
                                    <span class="font-bold text-yellow-600" id="elab-insulina">--</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2 mb-4">4. Volumen Total</h3>
                            <div class="bg-blue-600 text-white p-6 rounded-xl flex justify-between items-center shadow-md">
                                <div>
                                    <div class="text-blue-200 text-sm mb-1">Volumen Líquido a Administrar</div>
                                    <div class="text-3xl font-bold" id="elab-volumen">0 ml</div>
                                </div>
                                <i class="fa-solid fa-faucet-drip text-4xl text-blue-400"></i>
                            </div>
                        </div>

                        <div class="mt-8 border-t border-slate-100 pt-6">
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 pb-2 mb-4">5. Osmolaridad Teórica</h3>
                            <div class="bg-purple-600 text-white p-6 rounded-xl flex justify-between items-center shadow-md">
                                <div>
                                    <div class="text-purple-200 text-sm mb-1">Osmolaridad Calculada</div>
                                    <div class="text-3xl font-bold"><span id="elab-osmolaridad">0</span> mOsm/L</div>
                                </div>
                                <i class="fa-solid fa-flask text-4xl text-purple-400"></i>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-indigo-700 text-white px-6 py-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold"><i class="fa-solid fa-boxes-stacked mr-2"></i>Selección de Materias Primas</h2>
                    <span class="text-xs bg-indigo-500 px-2 py-1 rounded border border-indigo-400/50">Configuración de Bolsa</span>
                </div>
                
                <div class="p-6">
                    
                    <div class="mb-8 bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex flex-col md:flex-row justify-between gap-4 items-center">
                        <div class="w-full md:w-auto">
                            <label class="block text-sm font-bold text-indigo-900">Vía de Administración</label>
                            <select id="via-admin" class="mt-1 w-full md:w-auto border-indigo-300 rounded-lg p-2 text-sm font-semibold text-indigo-800" onchange="calculateCompounding()">
                                <option value="central">Vía Central (0 - 1500 mOsm/L)</option>
                                <option value="periferica">Vía Periférica (< 800 mOsm/L)</option>
                            </select>
                        </div>
                        
                        <div class="w-full md:w-auto bg-white border border-blue-100 rounded-xl p-3 flex items-center justify-between gap-4 shadow-sm min-w-[200px]">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-50 p-2 rounded-lg text-blue-600">
                                    <i class="fa-solid fa-droplet"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-700 text-xs">Osmolaridad Estimada</h3>
                                    <div class="text-xl font-bold text-slate-800 leading-tight">
                                        <span id="val-osmolaridad">0</span> <span class="text-xs text-slate-400">mOsm/L</span>
                                    </div>
                                </div>
                            </div>
                            <div id="osmolaridad-status" class="text-[10px] font-bold text-gray-400 px-2 py-1 bg-gray-100 rounded">---</div>
                        </div>
                    </div>

                    <div id="compounding-warnings" class="mb-6 hidden"></div>

                    <div class="grid gap-6">
                    
                        <div class="border border-red-100 rounded-xl p-3 md:p-4 bg-red-50/30">
                            <h4 class="font-bold text-red-700 mb-2 md:mb-3 flex items-center text-sm md:text-base">
                                <i class="fa-solid fa-dna mr-2"></i>Proteínas (Aminoácidos)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-end">
                                <div class="md:col-span-8">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Producto Comercial</label>
                                    <select id="sel-prot" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-xs md:text-sm focus:ring-red-500 focus:border-red-500" onchange="calculateCompounding()">
                                        <option value="">Seleccionar Aminoácido...</option>
                                    </select>
                                </div>
                                <div class="md:col-span-4">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 mt-2 md:mt-0">Volumen (ml)</label>
                                    <input type="number" id="vol-prot" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="border border-blue-100 rounded-xl p-3 md:p-4 bg-blue-50/30">
                            <h4 class="font-bold text-blue-700 mb-2 md:mb-3 flex items-center text-sm md:text-base">
                                <i class="fa-solid fa-cube mr-2"></i>Hidratos de Carbono (Glucosa)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-end">
                                <div class="md:col-span-8">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Producto Comercial</label>
                                    <select id="sel-hc" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-xs md:text-sm focus:ring-blue-500 focus:border-blue-500" onchange="calculateCompounding()">
                                        <option value="">Seleccionar Glucosa...</option>
                                    </select>
                                </div>
                                <div class="md:col-span-4">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 mt-2 md:mt-0">Volumen (ml)</label>
                                    <input type="number" id="vol-hc" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="border border-yellow-100 rounded-xl p-3 md:p-4 bg-yellow-50/30">
                            <h4 class="font-bold text-yellow-700 mb-2 md:mb-3 flex items-center text-sm md:text-base">
                                <i class="fa-solid fa-oil-can mr-2"></i>Lípidos (Emulsión)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-end">
                                <div class="md:col-span-8">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Producto Comercial</label>
                                    <select id="sel-lip" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-xs md:text-sm focus:ring-yellow-500 focus:border-yellow-500" onchange="calculateCompounding()">
                                        <option value="">Seleccionar Lípidos...</option>
                                    </select>
                                </div>
                                <div class="md:col-span-4">
                                    <label class="block text-xs font-medium text-slate-500 mb-1 mt-2 md:mt-0">Volumen (ml)</label>
                                    <input type="number" id="vol-lip" class="w-full border-slate-300 rounded-lg shadow-sm p-2 md:p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="border border-slate-200 rounded-xl p-4 bg-slate-50/50">
                            <h4 class="font-bold text-slate-600 mb-3 flex items-center">
                                <i class="fa-solid fa-vial mr-2"></i>Electrolitos y Agua
                            </h4>
                            <div class="grid gap-3">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente de Fosfato</label>
                                        <select id="sel-fosfato" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm text-slate-700" disabled>
                                             </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <input type="number" id="vol-fosfato" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-2 rounded border border-slate-100 mb-1">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente Potasio 1: Cloruro</label>
                                        <input type="text" value="CLORURO POTÁSICO 1M B.BRAUN" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-slate-100 text-sm text-slate-500" readonly>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-kcl" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm font-bold text-slate-700" placeholder="0" readonly>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-2 rounded border border-slate-100 mb-1">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente Potasio 2: Acetato</label>
                                        <input type="text" value="ACETATO POTÁSICO 1M B.BRAUN" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-slate-100 text-sm text-slate-500" readonly>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-k-acetato" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm font-bold text-slate-700" placeholder="0" readonly>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente de Magnesio</label>
                                        <select id="sel-magnesio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm focus:ring-slate-500 focus:border-slate-500" onchange="calculateCompounding()">
                                            </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <input type="number" id="vol-magnesio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente de Sodio (Restante)</label>
                                        <select id="sel-sodio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm text-slate-700" disabled>
                                            </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <input type="number" id="vol-sodio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                    </div>
                                </div>

                                 <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Fuente de Calcio</label>
                                        <select id="sel-calcio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm text-slate-700" disabled>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <input type="number" id="vol-calcio" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0" readonly>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end border-t border-slate-100 pt-2">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-bold text-blue-600 mb-1">Agua para Inyectables (API)</label>
                                        <select id="sel-api" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm text-slate-700" disabled>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <input type="number" id="vol-api" class="w-full border-blue-300 rounded-lg shadow-sm p-2.5 border bg-blue-50 text-sm font-bold text-blue-800" placeholder="0" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border border-green-100 rounded-xl p-4 bg-green-50/30">
                            <h4 class="font-bold text-green-700 mb-3 flex items-center">
                                <i class="fa-solid fa-tablets mr-2"></i>Vitaminas y Aditivos
                            </h4>
                            <div class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Aditivo 1</label>
                                        <select id="sel-vit-1" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm focus:ring-green-500 focus:border-green-500" onchange="updateVitaminVolume('sel-vit-1', 'vol-vit-1'); calculateCompounding()">
                                            <option value="">Seleccionar Aditivo...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-vit-1" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Aditivo 2</label>
                                        <select id="sel-vit-2" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm focus:ring-green-500 focus:border-green-500" onchange="updateVitaminVolume('sel-vit-2', 'vol-vit-2'); calculateCompounding()">
                                            <option value="">Seleccionar Aditivo...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-vit-2" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Aditivo 3</label>
                                        <select id="sel-vit-3" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm focus:ring-green-500 focus:border-green-500" onchange="updateVitaminVolume('sel-vit-3', 'vol-vit-3'); calculateCompounding()">
                                            <option value="">Seleccionar Aditivo...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-vit-3" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm" placeholder="0">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end mt-2 pt-2 border-t border-slate-100">
                                    <div class="md:col-span-8">
                                        <label class="block text-xs font-bold text-slate-700 mb-1">Tiamina (Aditivo 4)</label>
                                        <select id="sel-vit-4" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm focus:ring-green-500 focus:border-green-500" onchange="updateVitaminVolume('sel-vit-4', 'vol-vit-4'); calculateCompounding()">
                                            <option value="">Seleccionar Tiamina...</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-4">
                                        <label class="block text-xs font-medium text-slate-500 mb-1">Volumen (ml)</label>
                                        <input type="number" id="vol-vit-4" oninput="calculateCompounding()" class="w-20 border-slate-300 rounded-md text-sm p-1 text-right" placeholder="ml">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="border border-purple-100 rounded-xl p-4 bg-purple-50/30">
                                <h4 class="font-bold text-purple-700 mb-3 flex items-center">
                                    <i class="fa-solid fa-bag-shopping mr-2"></i>Capacidad de Bolsa
                                </h4>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Tipo de Bolsa / Volumen</label>
                                    <input type="text" id="res-bolsa" class="w-full border-slate-300 rounded-lg shadow-sm p-2.5 border bg-white text-sm font-bold text-purple-800" readonly>
                                    <select id="sel-bolsa" class="hidden"></select>
                                </div>
                            </div>

                            <div class="border border-gray-200 rounded-xl p-4 bg-gray-50/50">
                                <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                    <i class="fa-solid fa-syringe mr-2"></i>Material Fungible Total
                                </h4>
                                <div id="res-fungibles" class="text-xs text-slate-600 bg-white p-2 rounded border border-slate-200 h-24 overflow-y-auto font-mono">
                                    </div>
                                <select id="sel-fungible" class="hidden"></select>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        
        <div id="view-bibliografia" class="hidden slide-in max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold"><i class="fa-solid fa-book-medical mr-2"></i>Bibliografía y Referencias</h2>
                </div>
                
                <div class="p-8 space-y-6">
                    
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r">
                        <h3 class="text-lg font-bold text-blue-900 mb-2">Guías Clínicas ESPEN</h3>
                        <a href="https://www.espen.org/guidelines-home/espen-guidelines" target="_blank" class="text-blue-600 font-bold hover:underline text-sm"><i class="fa-solid fa-external-link-alt mr-1"></i> Acceder a las Guías ESPEN</a>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r">
                        <h3 class="text-lg font-bold text-orange-900 mb-2">Guías Clínicas ASPEN</h3>
                        <a href="https://nutritioncare.org/clinical-resources/guidelines-standards/" target="_blank" class="text-orange-600 font-bold hover:underline text-sm"><i class="fa-solid fa-external-link-alt mr-1"></i> Acceder a Recursos ASPEN</a>
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h4 class="font-bold text-slate-800 mb-4">Referencias Específicas Utilizadas</h4>
                        <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                            <li>ESPEN practical and partially revised guideline: Clinical nutrition in the intensive care unit. <a href="https://doi.org/10.1016/j.clnu.2023.07.011" target="_blank" class="text-blue-600 hover:underline">https://doi.org/10.1016/j.clnu.2023.07.011</a></li>
                            <li>Thibault R, Abbasoglu O, Ioannou E, Meija L, Ottens-Oussoren K, Pichard C, et al. ESPEN guideline on hospital nutrition. Clin Nutr. 2021;40:5684-5709. <a href="https://doi.org/10.1016/j.clnu.2021.09.039" target="_blank" class="text-blue-600 hover:underline">https://doi.org/10.1016/j.clnu.2021.09.039</a></li>
                            <li>Fichas técnicas de productos comerciales (B. Braun, Fresenius Kabi).</li>
                            <li>Olveira Fuster G, editor. Manual de nutrición clínica y dietética. 4.ª ed. Madrid: Díaz de Santos; 2023.</li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-config" class="hidden slide-in max-w-6xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden min-h-[600px] flex flex-col md:flex-row">
                
                <div class="w-full md:w-64 bg-slate-50 border-r border-slate-200 p-4 flex-shrink-0">
                    <h3 class="font-bold text-slate-700 mb-4 px-2">Categorías</h3>
                    <div class="space-y-1">
                        <button onclick="renderCategoryConfig('proteinas')" id="cat-btn-proteinas" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium hover:bg-white hover:shadow-sm transition cat-btn text-blue-600 bg-blue-50">Proteínas</button>
                        <button onclick="renderCategoryConfig('hidratos')" id="cat-btn-hidratos" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Hidratos de Carbono</button>
                        <button onclick="renderCategoryConfig('lipidos')" id="cat-btn-lipidos" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Lípidos</button>
                        <button onclick="renderCategoryConfig('electrolitos')" id="cat-btn-electrolitos" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Electrolitos</button>
                        <button onclick="renderCategoryConfig('vitaminas')" id="cat-btn-vitaminas" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Aditivos/Vitaminas</button>
                        <button onclick="renderCategoryConfig('bolsas')" id="cat-btn-bolsas" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Bolsas</button>
                        <button onclick="renderCategoryConfig('fungibles')" id="cat-btn-fungibles" class="w-full text-left px-4 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-white hover:shadow-sm transition cat-btn">Fungibles</button>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-slate-200">
                        <button onclick="resetDatabaseToFactory()" class="w-full flex items-center justify-center gap-2 text-red-600 hover:text-red-800 text-xs font-bold px-4 py-2 border border-red-200 rounded hover:bg-red-50 transition">
                            <i class="fa-solid fa-rotate-left"></i> Restaurar Fábrica
                        </button>
                    </div>
                </div>

                <div class="flex-grow p-6 overflow-y-auto">
                    
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="config-cat-title" class="text-xl font-bold text-slate-800">Gestionar Proteínas</h2>
                        <button onclick="showAddForm()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow transition flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Nuevo Producto
                        </button>
                    </div>

                    <div id="config-table-container" class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden mb-8">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3">Nombre Comercial</th>
                                    <th class="px-6 py-3">Detalles Clave</th>
                                    <th class="px-6 py-3 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="config-table-body" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>

                    <div id="add-item-form-container" class="hidden bg-slate-50 rounded-xl border border-slate-200 p-6 animate-fade-in">
                        <h3 class="font-bold text-slate-800 mb-4 pb-2 border-b border-slate-200">Añadir Nuevo Producto</h3>
                        <form id="add-item-form" onsubmit="event.preventDefault(); saveNewItem();">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">Nombre Comercial *</label>
                                    <input type="text" id="new-nombre" required class="w-full border-slate-300 rounded p-2 text-sm" placeholder="Ej: Glucosa 50%">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">Código Nacional</label>
                                    <input type="number" id="new-cn" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="Ej: 654321">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-600 mb-1">Osmolaridad (mOsm/L)</label>
                                    <input type="number" id="new-osm" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="0">
                                </div>
                            </div>

                            <div id="dynamic-fields-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-white p-4 rounded border border-slate-200">
                                </div>

                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="hideAddForm()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded text-sm font-medium">Cancelar</button>
                                <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-bold shadow">Guardar Producto</button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        
    </main>
    
<div id="printable-area" class="hidden bg-white p-8">
        
        <div class="print-header-row">
            <div>
                <h1 class="print-title">NutriCalc Hospitalaria</h1>
                <p class="print-subtitle">Informe Técnico de Nutrición Parenteral</p>
            </div>
            <div class="text-right text-sm text-gray-500">
                <p>Fecha: <span id="p-fecha"></span></p>
                <p>Generado automáticamente</p>
            </div>
        </div>

        <div class="print-section">
            <h3 class="font-bold text-lg mb-3 text-blue-800">1. Datos del Paciente y Evaluación</h3>
            <div class="print-grid">
                <div class="grid grid-cols-2 gap-y-2 gap-x-4">
                    <div style="grid-column: span 2;">
                        <div class="info-label">Paciente</div>
                        <div id="p-nombre" class="info-value" style="font-size: 14pt; color: #1e3a8a;">--</div>
                    </div>
                    <div><div class="info-label">NHC</div><div id="p-nhc" class="info-value">--</div></div>
                    <div><div class="info-label">Cama</div><div id="p-cama" class="info-value">--</div></div>
                    <div><div class="info-label">Edad / Sexo</div><div id="p-edad-sexo" class="info-value">--</div></div>
                    <div><div class="info-label">Peso / Altura</div><div id="p-antropo" class="info-value">--</div></div>
                    <div><div class="info-label">IMC</div><div id="p-imc" class="info-value">--</div></div>
                    <div><div class="info-label">Peso Cálculo</div><div id="p-peso-calc" class="info-value">--</div></div>
                </div>
                
                <div class="space-y-4">
                    <div class="box-highlight">
                        <div class="info-label mb-1">Riesgo Síndrome Realimentación</div>
                        <div id="p-riesgo" class="text-lg font-bold">--</div>
                    </div>
                    <div>
                        <div class="info-label">Ubicación y Protocolo</div>
                        <div id="p-protocolo" class="info-value text-sm mt-1">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="print-section">
            <h3 class="font-bold text-lg mb-3 text-blue-800">2. Prescripción Nutricional</h3>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>Parámetro</th>
                        <th class="text-right">Total Calculado</th>
                        <th class="text-right">Aporte por Kg/día</th>
                        <th class="text-right">Notas</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Energía Total</td>
                        <td class="text-right font-bold" id="p-kcal-total">--</td>
                        <td class="text-right text-gray-500">--</td>
                        <td class="text-right text-xs" id="p-kcal-nota"></td>
                    <tr>
                        <td>Kcal no prot. / g de N</td>
                        <td class="text-right font-bold" id="p-ratio-val">--</td>
                    </tr>
                    <tr>
                        <td>Proteínas</td>
                        <td class="text-right font-bold" id="p-prot-total">--</td>
                        <td class="text-right" id="p-prot-kg">--</td>
                        <td class="text-right text-xs">Aminoácidos</td>
                    </tr>
                    <tr>
                        <td>Hidratos de Carbono</td>
                        <td class="text-right font-bold" id="p-hc-total">--</td>
                        <td class="text-right" id="p-hc-kg">--</td>
                        <td class="text-right text-xs">Glucosa</td>
                    </tr>
                    <tr>
                        <td>Lípidos</td>
                        <td class="text-right font-bold" id="p-lip-total">--</td>
                        <td class="text-right" id="p-lip-kg">--</td>
                        <td class="text-right text-xs">Emulsión</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="print-section">
            <h3 class="font-bold text-lg mb-3 text-blue-800">3. Ficha de Elaboración (Mezcla)</h3>
            
            <table class="print-table">
                <thead>
                    <tr>
                        <th width="50%">Materia Prima / Producto Comercial</th>
                        <th width="25%" class="text-right">Volumen</th>
                        <th width="25%" class="text-right">Aporte Iónico / Nota</th>
                    </tr>
                </thead>
                <tbody id="p-tabla-mezcla">
                    </tbody>
                <tfoot>
                    <tr class="bg-blue-50 font-bold border-t-2 border-blue-800">
                        <td class="pt-2 text-blue-900">VOLUMEN FINAL A PREPARAR</td>
                        <td class="pt-2 text-right text-lg text-blue-900" id="p-vol-final">0 ml</td>
                        <td class="pt-2 text-right text-blue-900" id="p-osm-final">0 mOsm/L</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="print-section border-b-0" style="page-break-before: always;">
            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h4 class="font-bold text-sm uppercase text-gray-500 mb-2">Configuración de Bolsa</h4>
                    <div id="p-bolsa" class="text-xl font-bold border p-2 rounded text-center border-gray-300">--</div>
                    <div class="mt-2 text-xs text-gray-500">
                        Vía de Administración: <span id="p-via" class="font-bold text-black">--</span>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-sm uppercase text-gray-500 mb-2">Material Fungible Estimado</h4>
                    <div id="p-fungibles" class="text-sm font-mono border p-2 rounded bg-gray-50 h-full">
                        --
                    </div>
                </div>
                </div> </div> <div class="print-section" style="break-inside: avoid;">
            <h3 class="font-bold text-lg mb-3 text-blue-900 border-b-2 border-blue-900 pb-1">5. Proceso de Elaboración (Paso a Paso)</h3>
            
            <div id="p-elaboracion-steps" class="text-xs text-slate-700 space-y-4">
                </div>

            <div class="mt-4 p-2 bg-yellow-50 border border-yellow-200 rounded text-[10px] text-yellow-800 italic">
                * Nota: El tamaño de jeringa sugerido busca minimizar el número de cargas y maximizar la precisión.
            </div>
        </div>

        <div class="mt-8 pt-4 border-t-2 border-dashed border-gray-300 text-center text-xs text-gray-400">
            <p>Este documento es una ayuda al cálculo. Debe ser validado por el facultativo responsable.</p>
            <p>NutriCalc Hospitalaria © 2025</p>
        </div>

        <div id="labels-page-content"></div>

    </div> 

    <script>
        // 1. BASE DE DATOS ORIGINAL (BACKUP)
        // Renombramos la constante para que sirva de respaldo
        const MATERIAS_PRIMAS_DEFAULT = {
            proteinas: {
                "aminoplasmal_15": {
                    nombre: "AMINOPLASMAL B. BRAUN 15%",
                    concentracion_aa: 150, // g/L
                    nitrogeno: 24, // g/L
                    sodio: 5.3, // mmol/L
                    osmolaridad: 1290, // mOsm/l
                    codigo_nacional: 702953
                },
                "aminosteril_hepa_8": {
                    nombre: "AMINOSTERIL N-HEPA 8%",
                    concentracion_aa: 80, // g/L
                    nitrogeno: 12.9, // g/L
                    sodio: 0, // No especificado
                    osmolaridad: 770, // mOsm/l
                    kcal_l: 320,
                    codigo_nacional: 790410,
                    es_hepatico: true
                },
                "aminoven_15": {
                    nombre: "AMINOVEN 15%",
                    concentracion_aa: 150, // g/L
                    nitrogeno: 25.7, // g/L
                    sodio: 0,
                    osmolaridad: 1505, // mOsm/l
                    kcal_l: 600,
                    codigo_nacional: 858415
                }
            },
            hidratos: {
                "glucosa_braun_20": {
                    nombre: "GLUCOSA B.BRAUN 20%",
                    concentracion_hc: 200, // g/L
                    osmolaridad: 1110, // mOsm/l
                    kcal_l: 800,
                    codigo_nacional: 622985
                },
                "glucosa_braun_30": {
                    nombre: "GLUCOSA B.BRAUN 30%",
                    concentracion_hc: 300, // g/L
                    osmolaridad: 1665, // mOsm/l
                    kcal_l: 1200,
                    codigo_nacional: 606360
                },
                "glucosa_fresenius_20": {
                    nombre: "GLUCOSA FRESENIUS KABI 20%",
                    concentracion_hc: 200, // g/L
                    osmolaridad: 1110, // mOsm/l
                    kcal_l: 800,
                    codigo_nacional: 610790
                },
                "glucosa_braun_70": {
                    nombre: "GLUCOSA B.BRAUN 70%",
                    concentracion_hc: 700, // g/L
                    osmolaridad: 3890, // mOsm/l
                    kcal_l: 2800,
                    codigo_nacional: 660559
                },
                "glucosa_braun_5": {
                    nombre: "GLUCOSA B.BRAUN 5%",
                    concentracion_hc: 50, // g/L
                    osmolaridad: 278, // mOsm/l
                    kcal_l: 200,
                    codigo_nacional: 622324
                }
            },
            lipidos: {
                "smoflipid_20": {
                    nombre: "SMOFLIPID 200 mg/ml",
                    concentracion_lip: 200, // g/L
                    osmolaridad: 380, // mOsm
                    kcal_l: 2000,
                    sodio: 5, // mmol/L
                    codigo_nacional: 600123
                }
            },
            vitaminas: {
                "vitalipid_adultos": {
                    nombre: "VITALIPID ADULTOS",
                    volumen_envase: 10, // mL
                    codigo_nacional: 680405
                },
                "soluvit_liofilizado": {
                    nombre: "SOLUVIT LIOFILIZADO",
                    volumen_envase: 10, // mL (Reconstituido habitualmente en 10ml)
                    codigo_nacional: 677138
                },
                "oligostandard": {
                    nombre: "OLIGOSTANDARD CONCENTRADO",
                    volumen_envase: 10, // mL
                    codigo_nacional: 810390
                },
                "benerva_100": {
                    nombre: "BENERVA 100 MG/ML",
                    concentracion_mg: 100, // mg/mL
                    volumen_envase: 1, // mL
                    es_variable: true // Volume depends on calculated dose
                }
            },
            electrolitos: {
                "acetato_potasico_braun": {
                    nombre: "ACETATO POTÁSICO 1M B.BRAUN",
                    concentracion_potasio: 1000, // mEq/L
                    concentracion_acetato: 1000, // mEq/L
                    osmolaridad: 2000, // mOsm/L
                    codigo_nacional: 492153,
                    composicion: "Acetato 1000 mEq/L + Potasio 1000 mEq/L"
                },
                "cloruro_potasico_braun": {
                    nombre: "CLORURO POTÁSICO 1M B.BRAUN",
                    concentracion_potasio: 1000, // <--- CAMBIO CLAVE
                    concentracion_cloro: 1000,   // <--- CAMBIO CLAVE
                    osmolaridad: 2000, 
                    codigo_nacional: 461037,
                    composicion: "Cloruro 1000 mEq/L + Potasio 1000 mEq/L"
                },
                "glicerofosfato_sodico": {
                    nombre: "GLYCOPHOS 216 MG/ML VIAL 20ML",
                    concentracion_fosfato: 1000, // mEq/L
                    concentracion_sodio: 2000, // mEq/L
                    osmolaridad: 2760, // mOsm/L
                    codigo_nacional: 728213,
                    composicion: "Fosfato 1000 mEq/L + Sodio 2000 mEq/L"
                },
                "cloruro_sodico_20": {
                    nombre: "CLORURO DE SODIO B. BRAUN 20%",
                    concentracion_sodio: 3422, // mEq/L
                    concentracion_cloro: 3422, // mEq/L
                    osmolaridad: 6800, // mOsm/L (Aprox 2x3400)
                    codigo_nacional: 492155, 
                    composicion: "Sodio 3422 mEq/L + Cloro 3422 mEq/L"
                },
                "agua_inyectables_fresenius": {
                    nombre: "API FRESENIUS KABI 500ML",
                    concentracion_sodio: 0,
                    concentracion_cloro: 0,
                    concentracion_potasio: 0,
                    osmolaridad: 0,
                    codigo_nacional: 796748,
                    composicion: "Agua para inyectables (Exenta de electrolitos)"
                },
                "gluconato_calcico_5": {
                    nombre: "GLUCONATO CÁLCICO 5% B.BRAUN",
                    concentracion_calcio_mmol: 112.6, // mmol/L
                    concentracion_calcio_mEq: 225.2,  // mEq/L (112.6 * 2)
                    osmolaridad: 330, // mOsm/L
                    codigo_nacional: 460260,
                    composicion: "Calcio 112.6 mmol/L (225.2 mEq/L)"
                },
                "sulfato_magnesico_braun": {
                    nombre: "SULFATO MAGNÉSICO 0.5M B.BRAUN 500ML",
                    concentracion_magnesio: 1000, // mEq/L
                    concentracion_sulfato: 1000,  // mEq/L
                    osmolaridad: 1000,            // mOsm/L
                    codigo_nacional: 492158,
                    composicion: "Magnesio 1000 mEq/L + Sulfato 1000 mEq/L"
                }
            },
            bolsas: {
                "bolsa_1l": {
                    nombre: "Bolsa MULTICAPA 1 Litro",
                    capacidad_ml: 1000
                },
                "bolsa_3l": {
                    nombre: "Bolsa MULTICAPA 3 Litros",
                    capacidad_ml: 3000
                }
            },
            fungibles: {
                "jeringa_5": { nombre: "Jeringa 5 mL" }, 
                "jeringa_10": { nombre: "Jeringa 10 mL" },
                "jeringa_20": { nombre: "Jeringa 20 mL" },
                "jeringa_30": { nombre: "Jeringa 30 mL" },
                "jeringa_50": { nombre: "Jeringa 50 mL" }
            }
        };

// 2. VARIABLE ACTIVA (Se llenará con datos del usuario o default)
        let materiasPrimas = {};

        // 3. FUNCIÓN DE CARGA INICIAL DE DATOS
        function loadDatabase() {
            const savedData = localStorage.getItem('nutricalc_db_v1');
            
            if (savedData) {
                try {
                    materiasPrimas = JSON.parse(savedData);
                    console.log("Base de datos cargada desde LocalStorage");
                } catch (e) {
                    console.error("Error al leer datos, usando default", e);
                    materiasPrimas = JSON.parse(JSON.stringify(MATERIAS_PRIMAS_DEFAULT));
                }
            } else {
                console.log("Iniciando con Base de Datos por defecto");
                materiasPrimas = JSON.parse(JSON.stringify(MATERIAS_PRIMAS_DEFAULT));
            }
            // Inicializar selectores una vez cargados los datos
            initRawMaterials();
        }
        
        // Safety Limits for Parenteral Nutrition Preparation (Concentration per Liter of mixture)
        const limitesSeguridad = {
            // Electrolitos (Concentraciones máximas mEq/L o mmol/L)
            sodio_max: 180,       // mEq/L
            potasio_max: 100,     // mEq/L
            magnesio_max: 15,     // mEq/L
            cloro_max: 180,       // mEq/L
            acetato_max: 85,      // mEq/L
            ca_p_suma_max: 30,    // Regla compleja: Calcio (mEq/L) + Fosfato (mmol/L) <= 30

            // Macronutrientes (Concentración final en la mezcla %)
            // Aminoácidos: 2-5%
            aa_conc_min: 2, 
            aa_conc_max: 5,
            
            // Glucosa: 5-35%
            glu_conc_min: 5,
            glu_conc_max: 35,
            
            // Lípidos: 1.5-5%
            lip_conc_min: 1.5,
            lip_conc_max: 5
        };

        // FUNCIÓN MEJORADA: Llena los selectores dinámicamente desde la Base de Datos
        function initRawMaterials() {
            const populateSelect = (selectId, category, filterFn = null) => {
                const el = document.getElementById(selectId);
                if (!el) return;
                el.innerHTML = '<option value="">Seleccionar...</option>';
                const items = materiasPrimas[category] || {};
                
                for (const [key, item] of Object.entries(items)) {
                    if (filterFn && !filterFn(item)) continue;
                    const opt = document.createElement('option');
                    opt.value = key;
                    let text = item.nombre;
                    if (item.codigo_nacional) text += ` (CN: ${item.codigo_nacional})`;
                    if (item.es_hepatico) text += ' [HEPÁTICO]';
                    opt.text = text;
                    if (item.es_hepatico) { opt.style.color = "#d97706"; opt.style.fontWeight = "bold"; }
                    el.add(opt);
                }
                if (el.options.length > 1) el.disabled = false;
            };

            // 1. LISTAS GENERALES
            populateSelect('sel-prot', 'proteinas');
            populateSelect('sel-hc', 'hidratos');
            populateSelect('sel-lip', 'lipidos');
            populateSelect('sel-fosfato', 'electrolitos', item => item.concentracion_fosfato > 0);
            populateSelect('sel-magnesio', 'electrolitos', item => item.concentracion_magnesio > 0);
            populateSelect('sel-calcio', 'electrolitos', item => (item.concentracion_calcio_mEq > 0 || item.concentracion_calcio_mmol > 0));
            populateSelect('sel-sodio', 'electrolitos', item => item.concentracion_sodio > 0 && !item.concentracion_fosfato);
            populateSelect('sel-api', 'electrolitos', item => item.nombre.toUpperCase().includes("AGUA") || item.nombre.toUpperCase().includes("API"));
            
            populateSelect('sel-bolsa', 'bolsas');
            populateSelect('sel-fungible', 'fungibles');

            // --- CAMBIO CLAVE AQUÍ ---
            
            // VITAMINAS 1, 2 y 3: EXCLUIR TIAMINA
            // Mostramos todo lo que NO sea Tiamina/Benerva
            ['sel-vit-1', 'sel-vit-2', 'sel-vit-3'].forEach(id => {
                populateSelect(id, 'vitaminas', item => !item.nombre.toUpperCase().includes("TIAMINA") && !item.nombre.toUpperCase().includes("BENERVA"));
            });

            // VITAMINA 4: SOLO TIAMINA
            populateSelect('sel-vit-4', 'vitaminas', item => item.nombre.toUpperCase().includes("TIAMINA") || item.nombre.toUpperCase().includes("BENERVA"));


            // 2. PRE-SELECCIONES OBLIGATORIAS
            const defaults = {
                'sel-prot': 'aminoplasmal_15',
                'sel-hc': 'glucosa_braun_70',
                'sel-lip': 'smoflipid_20',
                'sel-fosfato': 'glicerofosfato_sodico',
                'sel-sodio': 'cloruro_sodico_20',
                'sel-magnesio': 'sulfato_magnesico_braun',
                'sel-calcio': 'gluconato_calcico_5',
                'sel-api': 'agua_inyectables_fresenius',
                
                // Pre-seleccionar Tiamina automáticamente si existe en la base de datos
                'sel-vit-4': 'benerva_100' // Asegúrate que este ID coincide con tu DB
            };

            for (const [id, val] of Object.entries(defaults)) {
                const el = document.getElementById(id);
                if (el && el.querySelector(`option[value="${val}"]`)) {
                    el.value = val;
                }
            }
        }

        // Helper to auto-fill volume for fixed-dose items like vitamins
        function updateVitaminVolume(selectId, volumeId) {
            const sel = document.getElementById(selectId);
            const volInput = document.getElementById(volumeId);
            const val = sel.value;
            
            if (val && materiasPrimas.vitaminas[val]) {
                const mat = materiasPrimas.vitaminas[val];
                if (!mat.es_variable) {
                      volInput.value = mat.volumen_envase;
                }
            } else {
                volInput.value = "";
            }
        }

        // UPDATED LOGIC: Select ONE syringe per component line based on total volume
        function getBestSyringe(vol) {
            if (vol <= 0) return [];
            
            // Lógica más precisa para volúmenes pequeños
            if (vol <= 5) return ["Jeringa 5 mL"];
            if (vol <= 10) return ["Jeringa 10 mL"];
            if (vol <= 20) return ["Jeringa 20 mL"];
            if (vol <= 30) return ["Jeringa 30 mL"];
            
            return ["Jeringa 50 mL"];
        }

        // --- FUNCIÓN DE BALANCE IÓNICO Y ELABORACIÓN (VERSIÓN ROBUSTA) ---
        function calculateCompounding(sourceTrigger) {
            // 1. LEER TARGETS (METAS)
            // Si el texto es '0' o '--', usamos 0.
            const getTxtVal = (id) => parseFloat(document.getElementById(id)?.innerText) || 0;
            const getInpVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;

            const targetProt = getTxtVal('elab-prot'); // Viene de la calculadora
            const targetHC = getTxtVal('elab-hc');
            const targetLip = getTxtVal('elab-lip');
            const targetVolAdmin = getInpVal('volumen-administrar');

            const targetNa = getInpVal('input-sodio');
            const targetK = getInpVal('input-potasio');
            const targetP = getInpVal('input-fosforo');
            const targetMg = getInpVal('input-magnesio');
            const targetCa = getInpVal('input-calcio');
            
            // Targets secundarios (Solver)
            let targetCl = getInpVal('input-cloro'); // El usuario puede pedir X cloro
            let targetAcetato = getInpVal('input-acetato');

            let totalVol = 0;
            let totalOsm = 0;
            let fungibles = [];
            let warnings = [];

            // Helper para obtener datos del producto seleccionado
            const getProd = (selectId, category) => {
                const sel = document.getElementById(selectId);
                if (sel && sel.value && materiasPrimas[category] && materiasPrimas[category][sel.value]) {
                    return materiasPrimas[category][sel.value];
                }
                return null;
            };

            // Helper cálculo volumen seguro
            const calcVol = (target, concPerLiter) => {
                if (target <= 0 || !concPerLiter) return 0;
                return target / (concPerLiter / 1000);
            };

            // --- A. MACRONUTRIENTES ---
            const pProt = getProd('sel-prot', 'proteinas');
            if (pProt) {
                const vol = calcVol(targetProt, pProt.concentracion_aa);
                document.getElementById('vol-prot').value = vol.toFixed(1);
                totalVol += vol;
                totalOsm += vol * (pProt.osmolaridad/1000);
                fungibles.push(...getBestSyringe(vol));
            }

            const pHc = getProd('sel-hc', 'hidratos');
            if (pHc) {
                const vol = calcVol(targetHC, pHc.concentracion_hc);
                document.getElementById('vol-hc').value = vol.toFixed(1);
                totalVol += vol;
                totalOsm += vol * (pHc.osmolaridad/1000);
                fungibles.push(...getBestSyringe(vol));
            }

            // LÍPIDOS (Calculamos Na si tienen)
            let naFromLip = 0;
            const pLip = getProd('sel-lip', 'lipidos');
            if (pLip) {
                const vol = calcVol(targetLip, pLip.concentracion_lip);
                document.getElementById('vol-lip').value = vol.toFixed(1);
                totalVol += vol;
                totalOsm += vol * (pLip.osmolaridad/1000);
                fungibles.push(...getBestSyringe(vol));
                if (pLip.sodio) naFromLip = vol * (pLip.sodio / 1000);
            }

            // --- B. ELECTROLITOS ---

            // 1. FOSFATO
            let volGlyco = 0, naFromGlyco = 0;
            const pPhos = getProd('sel-fosfato', 'electrolitos');
            if (targetP > 0 && pPhos) {
                volGlyco = calcVol(targetP, pPhos.concentracion_fosfato);
                document.getElementById('vol-fosfato').value = volGlyco.toFixed(1);
                totalVol += volGlyco;
                totalOsm += volGlyco * (pPhos.osmolaridad/1000);
                fungibles.push(...getBestSyringe(volGlyco));
                if (pPhos.concentracion_sodio) naFromGlyco = volGlyco * (pPhos.concentracion_sodio / 1000);
            } else {
                document.getElementById('vol-fosfato').value = 0;
            }

            // 2. MAGNESIO (Calcula Sulfato)
            let volMg = 0, sulfatoRes = 0;
            const pMg = getProd('sel-magnesio', 'electrolitos');
            if (targetMg > 0 && pMg) {
                volMg = calcVol(targetMg, pMg.concentracion_magnesio);
                document.getElementById('vol-magnesio').value = volMg.toFixed(1);
                totalVol += volMg;
                totalOsm += volMg * (pMg.osmolaridad/1000);
                fungibles.push(...getBestSyringe(volMg));
                if (pMg.concentracion_sulfato) sulfatoRes = volMg * (pMg.concentracion_sulfato / 1000);
            } else {
                document.getElementById('vol-magnesio').value = 0;
            }
            if(document.getElementById('input-sulfato')) document.getElementById('input-sulfato').value = sulfatoRes.toFixed(1);

            // 3. SODIO (Rellena el resto con NaCl o Acetato Na seleccionado)
            let naNeeded = targetNa - naFromLip - naFromGlyco;
            let volNa = 0, clFromNa = 0;
            const pNa = getProd('sel-sodio', 'electrolitos'); // Por defecto NaCl 20%
            
            if (naNeeded > 0 && pNa) {
                volNa = calcVol(naNeeded, pNa.concentracion_sodio);
                document.getElementById('vol-sodio').value = volNa.toFixed(1);
                totalVol += volNa;
                totalOsm += volNa * (pNa.osmolaridad/1000);
                fungibles.push(...getBestSyringe(volNa));
                if (pNa.concentracion_cloro) clFromNa = volNa * (pNa.concentracion_cloro / 1000);
            } else {
                document.getElementById('vol-sodio').value = 0;
            }

            // 4. POTASIO (Balance KCl vs AcetatoK)
            // Aquí usamos los productos fijos de la DB para el solver
            const pKCl = materiasPrimas.electrolitos['cloruro_potasico_braun'];
            const pKAc = materiasPrimas.electrolitos['acetato_potasico_braun']; 
            // NOTA: Si quisieras usar "Acetato Sódico" como pediste en el prompt, tendrías que haberlo añadido a la DB.
            // Asumo que te referías a "Acetato Potásico" para el balance de K, que es lo estándar.

            let volKCl = 0, volKAc = 0;
            let clTotal = clFromNa;
            let acTotal = 0;

            if (targetK > 0 && pKCl && pKAc) {
                // Algoritmo Solver: Intentar satisfacer Cloro primero
                let k_as_kcl = 0;
                let k_as_kac = 0;
                
                // Si el usuario edita Acetato manualmente, priorizamos eso
                if (sourceTrigger === 'input-acetato') {
                    let desiredAc = targetAcetato;
                    if (desiredAc > targetK) desiredAc = targetK; // No podemos dar mas acetato que K total
                    k_as_kac = desiredAc;
                    k_as_kcl = targetK - desiredAc;
                } else {
                    // Default: Priorizar Cloro
                    let clDeficit = targetCl - clFromNa;
                    if (clDeficit < 0) clDeficit = 0;
                    
                    if (clDeficit >= targetK) {
                        k_as_kcl = targetK; // Todo K como Cloruro
                    } else {
                        k_as_kcl = clDeficit;
                        k_as_kac = targetK - clDeficit; // El resto como Acetato
                    }
                }

                volKCl = calcVol(k_as_kcl, pKCl.concentracion_potasio); // Asegúrate de haber corregido la DB (.concentracion_potasio)
                volKAc = calcVol(k_as_kac, pKAc.concentracion_potasio);

                document.getElementById('vol-kcl').value = volKCl.toFixed(1);
                document.getElementById('vol-k-acetato').value = volKAc.toFixed(1);

                totalVol += (volKCl + volKAc);
                totalOsm += volKCl * (pKCl.osmolaridad/1000) + volKAc * (pKAc.osmolaridad/1000);
                if(volKCl>0) fungibles.push(...getBestSyringe(volKCl));
                if(volKAc>0) fungibles.push(...getBestSyringe(volKAc));

                clTotal += k_as_kcl; // KCl aporta Cl
                acTotal += k_as_kac; // KAc aporta Ac
            } else {
                document.getElementById('vol-kcl').value = 0;
                document.getElementById('vol-k-acetato').value = 0;
            }

            // Actualizar inputs calculados (sin disparar evento recursivo)
            const inpCl = document.getElementById('input-cloro');
            const inpAc = document.getElementById('input-acetato');
            if (inpCl && sourceTrigger !== 'input-cloro') inpCl.value = clTotal.toFixed(1);
            if (inpAc && sourceTrigger !== 'input-acetato') inpAc.value = acTotal.toFixed(1);


            // 5. CALCIO
            const pCa = getProd('sel-calcio', 'electrolitos');
            if (targetCa > 0 && pCa) {
                // Preferimos mEq, si no mmol*2
                const conc = pCa.concentracion_calcio_mEq || (pCa.concentracion_calcio_mmol * 2);
                const vol = calcVol(targetCa, conc);
                document.getElementById('vol-calcio').value = vol.toFixed(1);
                totalVol += vol;
                totalOsm += vol * (pCa.osmolaridad/1000);
                fungibles.push(...getBestSyringe(vol));
            } else {
                document.getElementById('vol-calcio').value = 0;
            }

            // 6. VITAMINAS Y ADITIVOS
            // Aditivos 1, 2, 3
            ['sel-vit-1', 'sel-vit-2', 'sel-vit-3'].forEach((id, idx) => {
                const volVal = parseFloat(document.getElementById(`vol-vit-${idx+1}`)?.value) || 0;
                if (volVal > 0) {
                    totalVol += volVal;
                    fungibles.push(...getBestSyringe(volVal));
                }
            });

            // Tiamina (Aditivo 4) - Tratamiento estándar
            // Simplemente leemos el volumen que haya puesto el usuario (o el automático por preselección)
            const volTiamina = parseFloat(document.getElementById('vol-vit-4')?.value) || 0;
            if (volTiamina > 0) {
                totalVol += volTiamina;
                fungibles.push(...getBestSyringe(volTiamina));
            }


            // --- RESULTADOS FINALES ---
            // API (Agua)
            let volApi = targetVolAdmin - totalVol;
            if (volApi < 0) {
                warnings.push(`⚠️ Volumen excedido en ${Math.abs(volApi).toFixed(0)} ml`);
                volApi = 0;
            }
            document.getElementById('vol-api').value = volApi.toFixed(1);
            totalVol += volApi; // Ahora totalVol es igual a targetVolAdmin (o más si nos pasamos)

            // Osmolaridad Final
            const finalOsm = totalVol > 0 ? (totalOsm / (totalVol/1000)) : 0;
            document.getElementById('val-osmolaridad').innerText = finalOsm.toFixed(0);
            document.getElementById('elab-osmolaridad').innerText = finalOsm.toFixed(0);

            // Alertas Osmolaridad
            const via = document.getElementById('via-admin')?.value || 'central';
            const statusEl = document.getElementById('osmolaridad-status');
            
            if (via === 'periferica') {
                if (finalOsm > 800) {
                    if(statusEl) { statusEl.innerText = "PELIGRO (>800)"; statusEl.className = "text-[10px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded border border-red-200"; }
                    warnings.push("Osmolaridad > 800 mOsm/L no apta para vía periférica.");
                } else {
                    if(statusEl) { statusEl.innerText = "OK Periférica"; statusEl.className = "text-[10px] font-bold text-green-600 bg-green-100 px-2 py-1 rounded border border-green-200"; }
                }
            } else {
                 if(statusEl) { statusEl.innerText = "OK Central"; statusEl.className = "text-[10px] font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded border border-blue-200"; }
            }

            // Mostrar Warnings (CORREGIDO: Ahora con color y estilo)
            const warnBox = document.getElementById('compounding-warnings');
            if (warnBox) {
                if (warnings.length > 0) {
                    warnBox.innerHTML = warnings.join('<br>');
                    warnBox.classList.remove('hidden');
                    
                    // ESTA ES LA LÍNEA QUE FALTABA (Elige una de las dos opciones):
                    
                    // OPCIÓN A: Estilo "Moderno" (Rojo suave, elegante)
                    // warnBox.className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 shadow-sm';
                    
                    // OPCIÓN B: Estilo "Clásico/Urgente" (Rojo fuerte, barra lateral, como antes) -> RECOMENDADO SI QUIERES QUE SE VEA MUCHO
                    warnBox.className = 'mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 font-bold shadow-md';
                    
                } else {
                    warnBox.classList.add('hidden');
                }
            }

            // Bolsa y Fungibles
            let bag = "Bolsa MULTICAPA 3 Litros"; // Default safety
            if (totalVol <= 1000) bag = "Bolsa MULTICAPA 1 Litro";
            else if (totalVol > 3000) bag = "Excede 3L (Revisar)";
            document.getElementById('res-bolsa').value = bag;

            const fCounts = {}; fungibles.forEach(x => fCounts[x] = (fCounts[x] || 0) + 1);
            const fHtml = Object.entries(fCounts).map(([k,v]) => `<div>${v}x ${k}</div>`).join('');
            if(document.getElementById('res-fungibles')) document.getElementById('res-fungibles').innerHTML = fHtml || "--";
        }

       // Call init on load
        window.addEventListener('DOMContentLoaded', () => {
            loadDatabase(); // CARGAR DB PRIMERO (Esto llamará a initRawMaterials internamente)
        });

        // State management
        let mode = 'uci'; // 'uci' or 'planta'
        let currentRiskStatus = 'none'; // 'none', 'moderate', 'severe'
        let currentTab = 'calculadora';

        function switchTab(tab) {
            currentTab = tab;
            
            // Actualizado para incluir config
            const tabs = ['calculadora', 'elaboracion', 'bibliografia', 'config'];
            const views = {
                'calculadora': 'view-calculadora',
                'elaboracion': 'view-elaboracion',
                'bibliografia': 'view-bibliografia',
                'config': 'view-config'
            };
            const tabIds = {
                'calculadora': 'tab-calc',
                'elaboracion': 'tab-elab',
                'bibliografia': 'tab-biblio',
                'config': 'tab-config'
            };

            // Ocultar todo
            tabs.forEach(t => {
                const viewEl = document.getElementById(views[t]);
                const tabEl = document.getElementById(tabIds[t]);
                
                if (viewEl) viewEl.classList.add('hidden');
                if (tabEl) {
                    tabEl.classList.remove('active');
                    tabEl.classList.add('inactive');
                }
            });

            // Mostrar activo
            const activeView = document.getElementById(views[tab]);
            const activeTab = document.getElementById(tabIds[tab]);
            
            if (activeView) activeView.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.classList.remove('inactive');
            }

            // Lógica específica por pestaña
            if (tab === 'elaboracion') {
                updateElaborationView();
                setTimeout(calculateCompounding, 100); 
                
                // Lógica Hepática (Hepatico check)
                const uciTipo = document.getElementById('uci-tipo').value;
                if (mode === 'uci' && uciTipo === 'hepatico') {
                    const selProt = document.getElementById('sel-prot');
                    if(selProt) {
                        selProt.value = 'aminosteril_hepa_8';
                        setTimeout(calculateCompounding, 150);
                    }
                }
            } else if (tab === 'config') {
                // AQUI ES DONDE HAS HECHO EL CAMBIO:
                // Inicializar el gestor visual en la primera categoría
                renderCategoryConfig('proteinas');
            }
        }

        function updateElaborationView() {
            // Check if calculation has been done (simple check on protein value)
            const protVal = document.getElementById('val-prot').innerText;
            
            if (protVal === '0' || protVal === '0.0') {
                document.getElementById('elaboracion-empty').classList.remove('hidden');
                document.getElementById('elaboracion-content').classList.add('hidden');
                return;
            }

            document.getElementById('elaboracion-empty').classList.add('hidden');
            document.getElementById('elaboracion-content').classList.remove('hidden');

            // 1. Macros - Visualización combinada AA / N
            const n2Val = document.getElementById('val-n2').innerText;
            
            // Texto principal combinando Gramos AA y Nitrógeno
            document.getElementById('elab-prot').innerHTML = 
                `${protVal} <span class="text-sm text-slate-600 font-normal">g aa</span> / ${n2Val} <span class="text-sm text-slate-600 font-normal">g N</span>`;

            // --- NUEVO CÁLCULO: Kcal y Ratio NPC/N ---
            const kcalProt = document.getElementById('kcal-prot').innerText;
            // Leemos valores numéricos asegurando que no sean NaN
            const kcalHC = parseFloat(document.getElementById('kcal-hc').innerText) || 0;
            const kcalLip = parseFloat(document.getElementById('kcal-lip').innerText) || 0;
            const gN = parseFloat(n2Val) || 0;

            // NPC = Non-Protein Calories (HC + Lípidos)
            // Nota: Si hay propofol o citrato, ya están descontados/ajustados en los gramos, 
            // pero aquí sumamos las kcal totales que aportan energía no proteica.
            const npc = kcalHC + kcalLip;
            
            // Ratio = NPC / Gramos de Nitrógeno
            const ratio = gN > 0 ? (npc / gN) : 0;

            document.getElementById('elab-kcal-prot').innerText = kcalProt;
            document.getElementById('elab-ratio-npcn').innerText = ratio.toFixed(0);
            // ------------------------------------------

            document.getElementById('elab-hc').innerText = document.getElementById('val-hc').innerText;
            document.getElementById('elab-lip').innerText = document.getElementById('val-lip').innerText;

            // 2. Electrolytes (Read from inputs)
            const elabList = document.getElementById('elab-electro-list');
            elabList.innerHTML = '';
            
            const electroItems = document.querySelectorAll('#electro-list li');
            
            electroItems.forEach(item => {
                const name = item.querySelector('.flex-col span:first-child').innerText;
                const inputVal = item.querySelector('input').value;
                const unit = item.querySelector('.text-xs.text-slate-500').innerText;
                
                const displayVal = inputVal ? `<strong>${inputVal}</strong> ${unit}` : '<span class="text-slate-400 italic">No especificado</span>';
                
                elabList.innerHTML += `
                    <tr>
                        <td class="py-2 font-medium text-slate-700">${name}</td>
                        <td class="py-2 text-right">${displayVal}</td>
                    </tr>
                `;
            });

            // 3. Additives
            document.getElementById('elab-tiamina').innerText = document.getElementById('val-tiamina').innerText;
            
            const insVal = document.getElementById('val-insulina').innerText;
            const insRow = document.getElementById('elab-insulina-row');
            if (document.getElementById('li-insulina').classList.contains('hidden')) {
                insRow.classList.add('hidden');
            } else {
                insRow.classList.remove('hidden');
                document.getElementById('elab-insulina').innerText = insVal;
            }

            // 4. Volume (Read from the user input box)
            const volInput = document.getElementById('volumen-administrar').value;
            const volDisplay = volInput ? `${volInput} ml` : document.getElementById('val-volumen-sugerido').innerText + " ml (Sugerido)";
            document.getElementById('elab-volumen').innerText = volDisplay;
        }

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('btn-uci').className = mode === 'uci' 
                ? "flex-1 py-2 rounded-lg font-medium border-2 border-blue-600 bg-blue-600 text-white transition"
                : "flex-1 py-2 rounded-lg font-medium border-2 border-slate-200 text-slate-600 hover:border-blue-400 transition";
            
            document.getElementById('btn-planta').className = mode === 'planta'
                ? "flex-1 py-2 rounded-lg font-medium border-2 border-orange-500 bg-orange-500 text-white transition"
                : "flex-1 py-2 rounded-lg font-medium border-2 border-slate-200 text-slate-600 hover:border-orange-400 transition";

            if(mode === 'uci') {
                document.getElementById('uci-fields').classList.remove('hidden');
                document.getElementById('planta-fields').classList.add('hidden');
            } else {
                document.getElementById('uci-fields').classList.add('hidden');
                document.getElementById('planta-fields').classList.remove('hidden');
            }
        }

        function checkIMC() {
            const peso = parseFloat(document.getElementById('peso').value) || 0;
            const alturaCm = parseFloat(document.getElementById('altura').value) || 0;
            const preview = document.getElementById('imc-preview');
            const modCheck = document.getElementById('mod-imc-check');
            const sevCheck = document.getElementById('sev-imc-check');
            
            // Reset styles
            modCheck.innerHTML = '<i class="fa-regular fa-square mr-2"></i> IMC 16 - 18 kg/m²';
            modCheck.className = 'flex items-center text-slate-400';
            sevCheck.innerHTML = '<i class="fa-regular fa-square mr-2"></i> IMC < 16 kg/m²';
            sevCheck.className = 'flex items-center text-slate-400';

            if (peso > 0 && alturaCm > 0) {
                const alturaM = alturaCm / 100;
                const imc = peso / (alturaM * alturaM);
                preview.innerText = `IMC: ${imc.toFixed(1)}`;
                
                if (imc < 16) {
                    sevCheck.innerHTML = '<i class="fa-solid fa-check-square mr-2"></i> IMC < 16 kg/m² (Detectado)';
                    sevCheck.className = 'flex items-center text-red-600 font-bold';
                } else if (imc >= 16 && imc <= 18) {
                    modCheck.innerHTML = '<i class="fa-solid fa-check-square mr-2"></i> IMC 16 - 18 kg/m² (Detectado)';
                    modCheck.className = 'flex items-center text-orange-600 font-bold';
                }
            } else {
                preview.innerText = 'IMC: --';
            }
            evaluateRisk();
        }

        function evaluateRisk() {
            // Recalculate IMC state dynamically
            const peso = parseFloat(document.getElementById('peso').value) || 0;
            const alturaCm = parseFloat(document.getElementById('altura').value) || 0;
            let imc = 100; // default safe
            if(peso > 0 && alturaCm > 0) {
                imc = peso / ((alturaCm/100)**2);
            }

            // Severe Checks (Requires 1)
            let severeCount = 0;
            if (imc < 16) severeCount++;
            if (document.getElementById('sev-weight').checked) severeCount++;
            if (document.getElementById('sev-fasting').checked) severeCount++;
            if (document.getElementById('sev-intake').checked) severeCount++;

            // Moderate Checks (Requires 2)
            let moderateCount = 0;
            if (imc >= 16 && imc <= 18) moderateCount++;
            if (document.getElementById('mod-weight').checked) moderateCount++;
            if (document.getElementById('mod-fasting').checked) moderateCount++;
            if (document.getElementById('mod-intake').checked) moderateCount++;

            const badge = document.getElementById('risk-badge');
            const optionsDiv = document.getElementById('refeeding-options'); // Referencia al nuevo selector

            if (severeCount >= 1) {
                currentRiskStatus = 'severe';
                badge.className = 'text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-bold border border-red-200';
                badge.innerText = 'RIESGO SEVERO';
                // MOSTRAR nuevo selector
                if(optionsDiv) optionsDiv.classList.remove('hidden');
            } else if (moderateCount >= 2) {
                currentRiskStatus = 'moderate';
                badge.className = 'text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold border border-orange-200';
                badge.innerText = 'RIESGO MODERADO';
                // MOSTRAR nuevo selector
                if(optionsDiv) optionsDiv.classList.remove('hidden');
            } else {
                currentRiskStatus = 'none';
                badge.className = 'text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold border border-green-200';
                badge.innerText = 'Sin Riesgo';
                // OCULTAR nuevo selector y resetear a fase 1
                if(optionsDiv) optionsDiv.classList.add('hidden');
                // Resetear el valor por seguridad para la próxima vez que aparezca
                if(document.getElementById('refeeding-phase')) document.getElementById('refeeding-phase').value = "0.25"; 
            }
        }

        function calcular() {
            // Actualizar riesgo primero para saber si mostrar el selector
            evaluateRisk();

            // 1. Obtener Datos Básicos
            const sexo = document.getElementById('sexo').value;
            const edad = parseFloat(document.getElementById('edad').value) || 0;
            const peso = parseFloat(document.getElementById('peso').value) || 0;
            const alturaCm = parseFloat(document.getElementById('altura').value) || 0;
            
            if (peso === 0 || alturaCm === 0) {
                alert("Por favor ingrese Peso y Altura válidos");
                return;
            }

            // 2. Antropometría
            const alturaM = alturaCm / 100;
            const imc = peso / (alturaM * alturaM);
            let ibw = 0;
            if (sexo === 'hombre') {
                ibw = (alturaM * alturaM) * 23; 
            } else {
                ibw = (alturaM * alturaM) * 22;
            }
            // --- LÓGICA DE AJUSTE PARA OBESIDAD ---
            let pesoCalculo = peso; // Por defecto usamos peso real
            
            if (imc > 30) {
                // Si es obeso, calculamos el PESO AJUSTADO usando TU Peso Ideal
                // Fórmula: Tu IBW + 25% del exceso de peso
                pesoCalculo = ibw + ((peso - ibw) * 0.25);
            }

            // 3. Cálculo de Kcal Base (Objetivo Teórico 100%)
            let baseTargetKcal = 0;
            
            // Lógica UCI vs Planta (Para sacar las calorías base teóricas)
            if (mode === 'uci') {
                const tipo = document.getElementById('uci-tipo').value;
                const fase = document.getElementById('uci-dias').value;
                const isVent = document.getElementById('vent-mec').checked;

                if (imc > 30 && imc <= 50 && tipo === 'normal') {
                    baseTargetKcal = 25 * pesoCalculo; 
                } 

                else if (tipo === 'sepsis') {
                    baseTargetKcal = (fase === 'aguda') ? 20 * pesoCalculo : 27.5 * pesoCalculo; 
                } else if (tipo === 'hepatico') {
                    baseTargetKcal = 19 * pesoCalculo; 
                } else {
                    baseTargetKcal = (fase === 'aguda') ? 19 * pesoCalculo : 27.5 * pesoCalculo;
                }
                
                if (isVent && tipo === 'normal') baseTargetKcal = 22.5 * pesoCalculo;

            } else {
                // Planta: Harris Benedict
                let geb = 0;
                if (sexo === 'hombre') {
                    geb = 66.5 + (13.75 * peso) + (5.003 * alturaCm) - (6.755 * edad);
                } else {
                    geb = 655.1 + (9.563 * peso) + (1.850 * alturaCm) - (4.676 * edad);
                }
                
                const estres = document.getElementById('planta-estres').value; 
                const actividad = parseFloat(document.getElementById('planta-actividad').value);
                
                let factorEstresVal = 1.1;
                if(estres === 'moderado') factorEstresVal = 1.25;
                if(estres === 'intenso') factorEstresVal = 1.45;

                baseTargetKcal = geb * actividad * factorEstresVal;
            }

            // 4. Lógica de Riesgo Realimentación y Reparto Macros
            const hasRefeedingRisk = (currentRiskStatus === 'severe' || currentRiskStatus === 'moderate');
            let warnings = [];
            
            let finalKcal = 0;
            let gramsProt = 0;
            let gramsHC = 0;
            let gramsLip = 0;
            let targetProtPerKg = 0; // Solo informativo si hay riesgo

            // Aportes Externos (Propofol / Citrato) - Se restan de los gramos finales de bolsa
            const propofolMl = parseFloat(document.getElementById('propofol').value) || 0;
            const citratoMmol = parseFloat(document.getElementById('citrato').value) || 0;
            const propofolKcal = propofolMl * 1.1; // 1ml 1% = 1.1 kcal (aprox lipidica pura)
            const citratoKcal = citratoMmol * 0.59; // 1mmol citrato = 0.59 kcal (glucosa eq)

            // ===== LÓGICA NUEVA DE REALIMENTACIÓN =====
            if (hasRefeedingRisk) {
                // A) Obtener factor de reducción del nuevo selector (0.25, 0.60 o 1.0)
                const refeedingFactor = parseFloat(document.getElementById('refeeding-phase').value) || 0.25;
                
                // B) Calcular Calorías Finales Ajustadas
                finalKcal = baseTargetKcal * refeedingFactor;

                // C) Generar Advertencias
                const riskLabel = (currentRiskStatus === 'severe') ? 'SEVERO' : 'MODERADO';
                warnings.push(`⚠️ RIESGO REALIMENTACIÓN: <strong>${riskLabel}</strong>`);
                warnings.push(`Ajuste Fase: ${(refeedingFactor * 100).toFixed(0)}% del requerimiento (${baseTargetKcal.toFixed(0)} kcal).`);
                warnings.push("SUPLEMENTAR TIAMINA OBLIGATORIA (300mg/día x 3 días)");

                // D) Reparto Fijo: 50% HC / 30% Lípidos / 20% Proteínas
                const kcalProtTotal = finalKcal * 0.20;
                const kcalHCTotal = finalKcal * 0.50;
                const kcalLipTotal = finalKcal * 0.30;

                // E) Convertir a Gramos
                gramsProt = kcalProtTotal / 4;
                
                // HC: Restamos kcal de citrato
                const bagKcalHC = Math.max(0, kcalHCTotal - citratoKcal);
                gramsHC = bagKcalHC / 4;

                // Lip: Restamos kcal de propofol
                const bagKcalLip = Math.max(0, kcalLipTotal - propofolKcal);
                gramsLip = bagKcalLip / 9; // Usamos 9 kcal/g para cálculo inverso

                // Actualizar UI para reflejar modo Realimentación
                targetProtPerKg = gramsProt / pesoCalculo; 
                document.getElementById('prot-target').innerText = `Refeeding (20%): ${targetProtPerKg.toFixed(2)} g/kg`;
                
                document.getElementById('hc-ratio-display').innerText = "Glucosa (50% Fijo)";
                document.getElementById('lip-ratio-display').innerText = "Emulsión (30% Fijo)";
                
                // Deshabilitar selector manual para evitar confusión
                const ratioSel = document.getElementById('ratio-hc-lip');
                ratioSel.disabled = true;
                ratioSel.title = "Deshabilitado por Protocolo de Realimentación";

            } else {
                // ===== LÓGICA ESTÁNDAR (Sin Riesgo) =====
                finalKcal = baseTargetKcal;
                
                // Habilitar selector manual
                const ratioSel = document.getElementById('ratio-hc-lip');
                ratioSel.disabled = false;
                ratioSel.title = "";

                // A) Calcular Objetivo Proteico g/kg según patología
                if (mode === 'uci') {
                    const tipo = document.getElementById('uci-tipo').value;
                    const fase = document.getElementById('uci-dias').value;
                    const isVent = document.getElementById('vent-mec').checked;

                    if (tipo === 'hepatico') targetProtPerKg = 1.25;
                    else if (tipo === 'fistula') targetProtPerKg = 2.25;
                    else if (tipo === 'sepsis') targetProtPerKg = (fase === 'aguda') ? 1.4 : 1.75;
                    else if (isVent) targetProtPerKg = 1.5;
                    else if (imc <= 30) targetProtPerKg = (fase === 'aguda') ? 1.35 : 1.75;
                    else targetProtPerKg = 1.3; 
                } else {
                    const estres = document.getElementById('planta-estres').value;
                    if(estres === 'leve') targetProtPerKg = 1.1;
                    else if(estres === 'moderado') targetProtPerKg = 1.25;
                    else targetProtPerKg = 1.45;
                }

                gramsProt = targetProtPerKg * pesoCalculo;
                const kcalProt = gramsProt * 4;
                
                // B) Calcular Calorías No Proteicas
                let nonProteinKcal = finalKcal - kcalProt;
                if (nonProteinKcal < 0) nonProteinKcal = 0;

                // C) Reparto HC/Lípidos según selector manual
                const ratioVal = parseInt(ratioSel.value) || 60;
                const ratioHC = ratioVal / 100;
                const ratioLip = 1 - ratioHC;

                const targetKcalHC = nonProteinKcal * ratioHC;
                const targetKcalLip = nonProteinKcal * ratioLip;

                // D) Restar Externos y convertir a gramos
                const bagKcalHC = Math.max(0, targetKcalHC - citratoKcal);
                gramsHC = bagKcalHC / 4;

                const bagKcalLip = Math.max(0, targetKcalLip - propofolKcal);
                gramsLip = bagKcalLip / 10; // Estándar comercial (10 kcal/g incluye glicerol)

                // UI Updates
                document.getElementById('prot-target').innerText = `Target: ${targetProtPerKg.toFixed(2)} g/kg`;
                document.getElementById('hc-ratio-display').innerText = `Glucosa (${ratioVal}%)`;
                document.getElementById('lip-ratio-display').innerText = `Emulsión lipídica (${100-ratioVal}%)`;
            }

            // 5. Chequeos de Seguridad Finales (Límites g/kg)
            const currentHCperKg = (gramsHC * 4 + citratoKcal)/4 / pesoCalculo;
            // Para el chequeo de seguridad de lípidos usamos siempre 9 kcal/g como referencia fisiológica
            const currentLipperKg = (gramsLip * 9 + propofolKcal)/9 / pesoCalculo; 

            const limitHC = (mode === 'uci' && document.getElementById('uci-tipo').value === 'hepatico') ? 2 : 5; 
            const limitLip = 1.5; 

            if (currentHCperKg > limitHC) warnings.push(`Aviso: Aporte alto de HC (${currentHCperKg.toFixed(1)} g/kg).`);
            if (currentLipperKg > limitLip) warnings.push(`Aviso: Aporte alto de Lípidos (${currentLipperKg.toFixed(1)} g/kg).`);

            // 6. Renderizar Resultados
            document.getElementById('results-content').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            
            document.getElementById('res-imc').innerText = imc.toFixed(1);
            document.getElementById('res-ibw').innerText = ibw.toFixed(1);
            document.getElementById('res-calc-weight').innerText = pesoCalculo.toFixed(1);
            
            const alertsBox = document.getElementById('alerts-box');
            if (warnings.length > 0) {
                alertsBox.classList.remove('hidden');
                document.getElementById('alerts-text').innerHTML = warnings.join('<br>');
            } else {
                alertsBox.classList.add('hidden');
            }

            document.getElementById('total-kcal').innerText = finalKcal.toFixed(0) + " kcal/día";
            document.getElementById('kcal-type-label').innerText = hasRefeedingRisk ? "TOTAL AJUSTADO (RIESGO)" : "TOTAL CALCULADO";
            
            document.getElementById('val-prot').innerText = gramsProt.toFixed(1);
            document.getElementById('kcal-prot').innerText = (gramsProt * 4).toFixed(0);
            
            // Calculo Nitrógeno
            const valN2 = gramsProt / 6.25;
            document.getElementById('val-n2').innerText = valN2.toFixed(1);

            document.getElementById('val-hc').innerText = gramsHC.toFixed(1);
            document.getElementById('kcal-hc').innerText = (gramsHC * 4).toFixed(0);
            
            if(citratoKcal > 0) {
                document.getElementById('citrato-warning').classList.remove('hidden');
                document.getElementById('val-citrato-kcal').innerText = citratoKcal.toFixed(0);
            } else document.getElementById('citrato-warning').classList.add('hidden');

            document.getElementById('val-lip').innerText = gramsLip.toFixed(1);
            
            // Visualización kcal lípidos
            const displayKcalLip = hasRefeedingRisk ? (gramsLip * 9) : (gramsLip * 10);
            document.getElementById('kcal-lip').innerText = displayKcalLip.toFixed(0);
            
            // --- NUEVO CÁLCULO: NPC/N PARA LA CALCULADORA ---
            // NPC = Kcal HC + Kcal Lipidos (Valores mostrados)
            const kcalNPC = (gramsHC * 4) + displayKcalLip; 
            const ratioNPCN = valN2 > 0 ? (kcalNPC / valN2) : 0;
            const ratioEl = document.getElementById('calc-ratio-npcn');
            if(ratioEl) ratioEl.innerText = ratioNPCN.toFixed(0);
            // ------------------------------------------------

            if(propofolKcal > 0) {
                document.getElementById('propofol-warning').classList.remove('hidden');
                document.getElementById('val-propofol-lip').innerText = (propofolMl * 0.1).toFixed(1);
            } else {
                document.getElementById('propofol-warning').classList.add('hidden');
            }

            // --- REGENERACIÓN LISTA IONES Y VOLUMEN ---
            const elList = document.getElementById('electro-list');
            elList.innerHTML = '';

            const createRow = (label, id, unit, subtitle, isAuto = false, isReadOnly = false) => `
            <li class="flex items-center justify-between border-b border-slate-100 py-2 ${isAuto ? 'bg-blue-50/30 px-2 -mx-2 rounded' : ''}">
                <div class="flex flex-col">
                    <span class="font-medium text-sm text-slate-700">${label}</span>
                    <span class="text-[10px] ${isAuto ? 'text-slate-400' : 'text-blue-600 font-semibold'}">${subtitle}</span>
                </div>
                <div class="flex items-center gap-1">
                    <input type="number" id="${id}" 
                           ${isReadOnly ? 'readonly' : `onchange="calculateCompounding('${id}')"`} 
                           class="w-20 text-sm border-${isAuto ? 'blue-300' : 'slate-300'} rounded-md p-1 border text-right focus:ring-blue-500 bg-${isAuto || isReadOnly ? 'white' : 'slate-50'} font-bold text-${isAuto ? 'blue-800' : 'slate-700'} ${isReadOnly ? 'cursor-not-allowed text-slate-400' : ''}" 
                           placeholder="${isAuto ? 'Auto' : '0'}">
                    <span class="text-xs text-slate-500 w-8">${unit}</span>
                </div>
            </li>`;

            elList.innerHTML += createRow('Sodio', 'input-sodio', 'mEq', `Rango: ${(1*pesoCalculo).toFixed(0)} - ${(2*pesoCalculo).toFixed(0)} mEq`);
            elList.innerHTML += createRow('Potasio', 'input-potasio', 'mEq', `Rango: ${(1*pesoCalculo).toFixed(0)} - ${(1.5*pesoCalculo).toFixed(0)} mEq`);
            elList.innerHTML += createRow('Cloro', 'input-cloro', 'mEq', 'Derivado de NaCl y KCl', true); // Auto
            elList.innerHTML += createRow('Acetato', 'input-acetato', 'mEq', 'Equilibrio Ácido-Base', true); // Auto
            elList.innerHTML += createRow('Calcio', 'input-calcio', 'mEq', '10 - 15 mEq Total');
            elList.innerHTML += createRow('Magnesio', 'input-magnesio', 'mEq', '8 - 20 mEq');
            elList.innerHTML += createRow('Sulfato', 'input-sulfato', 'mEq', 'Derivado de Magnesio', false, true); // Readonly
            elList.innerHTML += createRow('Fósforo', 'input-fosforo', 'mmol', '20 - 40 mmol');

            // Lógica de Tiamina e Insulina
            if (hasRefeedingRisk) {
                document.getElementById('val-tiamina').innerText = "300 mg (3 días)";
                document.getElementById('val-tiamina').classList.add('text-red-600', 'font-extrabold');
            } else {
                document.getElementById('val-tiamina').innerText = "3 mg";
                document.getElementById('val-tiamina').classList.remove('text-red-600', 'font-extrabold');
            }
            const liInsulina = document.getElementById('li-insulina');
            if (gramsHC > 0) {
                liInsulina.classList.remove('hidden');
                const units = (gramsHC / 160) * 16;
                document.getElementById('val-insulina').innerText = Math.round(units) + " UI";
            } else { liInsulina.classList.add('hidden'); }
            
            // --- FLUID BALANCE LOGIC ---
            const diuresis = parseFloat(document.getElementById('diuresis').value) || 0;
            const suero = parseFloat(document.getElementById('suero').value) || 0;
            let volumen = 0;
            const estandarVolumen = 30 * pesoCalculo; 

            if (diuresis > 0) {
                volumen = diuresis + 500 - suero;
                if(volumen < 0) volumen = 0; 
                document.getElementById('vol-formula').innerText = 'Balance Hídrico (Diuresis + 500 - Suero)';
            } else if (suero > 0) {
                volumen = estandarVolumen - suero;
                if(volumen < 0) volumen = 0;
                document.getElementById('vol-formula').innerText = 'Estimación por peso (30ml/kg) - Suero externo';
            } else {
                volumen = estandarVolumen;
                document.getElementById('vol-formula').innerText = 'Estimación estándar (30ml/kg)';
            }
            
            const volumenFixed = volumen.toFixed(0);
            document.getElementById('val-volumen-sugerido').innerText = volumenFixed;
            document.getElementById('volumen-administrar').value = volumenFixed;

            // Recalcular mezcla
            setTimeout(calculateCompounding, 50);
        }

function prepareAndPrint() {
            // 1. Asegurar cálculos actualizados
            calculateCompounding(); 

            // --- CÁLCULO PREVIO DEL RATIO NPC/N ---
            const n2Val = parseFloat(document.getElementById('val-n2').innerText) || 0;
            const kcalHC = parseFloat(document.getElementById('kcal-hc').innerText) || 0;
            const kcalLip = parseFloat(document.getElementById('kcal-lip').innerText) || 0;
            
            const ratioNPCN = n2Val > 0 ? ((kcalHC + kcalLip) / n2Val) : 0;
            const ratioStr = ratioNPCN.toFixed(0);

            // --- A. RELLENAR EL INFORME PRINCIPAL ---
            const now = new Date();
            const fechaStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('p-fecha').innerText = fechaStr;
            
            // Datos básicos (CON NOMBRE AÑADIDO)
            const nombre = document.getElementById('nombre-paciente').value || 'PACIENTE SIN NOMBRE';
            const nhc = document.getElementById('nhc').value || '-';
            const cama = document.getElementById('cama').value || '-';
            const peso = parseFloat(document.getElementById('peso').value) || 0;
            const pesoCalc = parseFloat(document.getElementById('res-calc-weight').innerText) || peso;
            const edad = document.getElementById('edad').value;
            const sexo = document.getElementById('sexo').value;

            // Inyectar en Informe
            document.getElementById('p-nombre').innerText = nombre;
            document.getElementById('p-nhc').innerText = nhc;
            document.getElementById('p-cama').innerText = cama;
            document.getElementById('p-edad-sexo').innerText = `${edad} a / ${sexo.charAt(0).toUpperCase() + sexo.slice(1)}`;
            document.getElementById('p-antropo').innerText = `${peso} kg / ${document.getElementById('altura').value} cm`;
            document.getElementById('p-imc').innerText = document.getElementById('res-imc').innerText;
            document.getElementById('p-peso-calc').innerText = pesoCalc + ' kg';

            // Riesgo y Protocolo
            const riskBadge = document.getElementById('risk-badge');
            const pRisk = document.getElementById('p-riesgo');
            pRisk.innerText = riskBadge.innerText;
            pRisk.className = riskBadge.innerText.includes('SEVERO') ? "text-lg font-bold text-red-600" : (riskBadge.innerText.includes('MODERADO') ? "text-lg font-bold text-orange-600" : "text-lg font-bold text-green-600");

            let protocolText = mode === 'uci' 
                ? `UCI: ${document.getElementById('uci-tipo').value}` 
                : `Planta: ${document.getElementById('planta-estres').value}`;
            document.getElementById('p-protocolo').innerText = protocolText;
            
            // Datos Prescripción
            const kcalTotal = parseFloat(document.getElementById('total-kcal').innerText);
            document.getElementById('p-kcal-total').innerText = document.getElementById('total-kcal').innerText;
            document.getElementById('p-kcal-nota').innerText = document.getElementById('kcal-type-label').innerText;
            
            document.getElementById('p-ratio-val').innerText = ratioStr;

            // Actualizar Proteínas en el Informe
            const valProt = document.getElementById('val-prot').innerText;
            const valN2 = document.getElementById('val-n2').innerText;

            document.getElementById('p-prot-total').innerHTML = `${valProt} <span style="font-weight:normal; font-size:0.8em">g aa</span> / ${valN2} <span style="font-weight:normal; font-size:0.8em">g N</span>`;
            document.getElementById('p-prot-kg').innerText = document.getElementById('prot-target').innerText;
            document.getElementById('p-hc-total').innerText = document.getElementById('val-hc').innerText + ' g';
            document.getElementById('p-hc-kg').innerText = (parseFloat(document.getElementById('val-hc').innerText)/pesoCalc).toFixed(2) + ' g/kg';
            document.getElementById('p-lip-total').innerText = document.getElementById('val-lip').innerText + ' g';
            document.getElementById('p-lip-kg').innerText = (parseFloat(document.getElementById('val-lip').innerText)/pesoCalc).toFixed(2) + ' g/kg';

            // --- TABLA Y GUION (Preparación de datos) ---
            const tableBody = document.getElementById('p-tabla-mezcla');
            tableBody.innerHTML = '';
            
            const getData = (volId, selId = null, staticName = null) => {
                const volInput = document.getElementById(volId);
                const vol = parseFloat(volInput?.value || 0);
                if (vol <= 0) return null;
                let name = staticName;
                if (!name && selId) {
                    const sel = document.getElementById(selId);
                    if(sel.selectedIndex >= 0) name = sel.options[sel.selectedIndex].text;
                    else name = sel.value;
                }
                // CORRECCIÓN: Lógica actualizada para el informe (incluye 5ml y 2ml)
                let syr = "50 ml";
                if (vol <= 5) syr = "5 ml"; 
                else if (vol <= 10) syr = "10 ml";
                else if (vol <= 20) syr = "20 ml";
                else if (vol <= 30) syr = "30 ml";
                return { name, vol, syr };
            };

            const addTableRow = (d, note='') => {
                if(d) tableBody.innerHTML += `<tr><td>${d.name}</td><td class="text-right font-bold">${d.vol.toFixed(1)} ml</td><td class="text-right text-xs text-gray-500">${note}</td></tr>`;
            };

            // Recopilar Datos
            const dProt = getData('vol-prot', 'sel-prot');
            const dPhos = getData('vol-fosfato', 'sel-fosfato');
            const dMg = getData('vol-magnesio', 'sel-magnesio');
            const dNa = getData('vol-sodio', 'sel-sodio');
            const dKcl = getData('vol-kcl', null, 'CLORURO POTÁSICO 1M');
            const dKac = getData('vol-k-acetato', null, 'ACETATO POTÁSICO 1M');
            const dCa = getData('vol-calcio', 'sel-calcio');
            const dHc = getData('vol-hc', 'sel-hc');
            const dLip = getData('vol-lip', 'sel-lip');
            const dVit1 = getData('vol-vit-1', 'sel-vit-1');
            const dVit2 = getData('vol-vit-2', 'sel-vit-2');
            const dVit3 = getData('vol-vit-3', 'sel-vit-3');
            const dVit4 = getData('vol-vit-4', null, 'TIAMINA (BENERVA) 100mg/ml');
            const dApi = getData('vol-api', null, 'AGUA PARA INYECTABLES');

            addTableRow(dProt); addTableRow(dPhos, 'Fósforo'); addTableRow(dMg, 'Magnesio');
            addTableRow(dNa, 'Sodio'); addTableRow(dKcl, 'Potasio'); addTableRow(dKac, 'Potasio');
            addTableRow(dCa, 'Calcio'); addTableRow(dHc); addTableRow(dLip);
            addTableRow(dVit1); addTableRow(dVit2); addTableRow(dVit3); addTableRow(dVit4, 'Protocolo');
            addTableRow(dApi, 'Vehículo');

            // --- GENERAR GUION PASO A PASO ---
            const stepContainer = document.getElementById('p-elaboracion-steps');
            let stepsHtml = '';
            
            const createStepLine = (d) => {
                if(!d) return '';
                return `<div class="flex items-start pl-2 mb-1 border-l-2 border-slate-300"><div class="flex-1">Cargar <span class="font-bold text-slate-900 bg-slate-100 px-1 rounded">${d.vol.toFixed(1)} ml</span> de <span class="font-medium text-slate-800">${d.name}</span>.</div><div class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 whitespace-nowrap"><i class="fa-solid fa-syringe mr-1"></i>Jer. ${d.syr}</div></div>`;
            };

            // --- NUEVO: ADVERTENCIA FILTRO (Antes del Paso 1) ---
            stepsHtml += `<div class="mb-4 p-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 text-xs flex items-center font-medium">
                <i class="fa-solid fa-filter mr-2 text-yellow-600"></i>
                <span>Utilizar SIEMPRE para cargar cualquier AMPOLLA DE VIDRIO o el CALCIO una jeringa con <strong>filtro de 5 µm</strong></span>
            </div>`;

            // Pasos 1, 2, 3
            stepsHtml += `<div class="mb-3"><h4 class="font-bold text-blue-800 text-sm mb-1">PASO 1: Mezcla Base (Aminoácidos + Glucosa)</h4>`;
            if(dProt) stepsHtml += createStepLine(dProt); if(dHc) stepsHtml += createStepLine(dHc); stepsHtml += `</div>`;

            stepsHtml += `<div class="mb-3"><h4 class="font-bold text-blue-800 text-sm mb-1">PASO 2: Electrolitos Monovalentes</h4>`;
            if(dNa) stepsHtml += createStepLine(dNa); if(dKcl) stepsHtml += createStepLine(dKcl); if(dKac) stepsHtml += createStepLine(dKac); stepsHtml += `</div>`;

            stepsHtml += `<div class="mb-3"><h4 class="font-bold text-blue-800 text-sm mb-1">PASO 3: Tamponamiento y Agua</h4>`;
            if(dPhos) stepsHtml += createStepLine(dPhos); if(dMg) stepsHtml += createStepLine(dMg); if(dApi) stepsHtml += createStepLine(dApi); stepsHtml += `</div>`;

            // PASO 4: CALCIO
            stepsHtml += `<div class="mb-3 bg-red-50 p-2 rounded border border-red-100">
                <h4 class="font-bold text-red-700 text-sm mb-1 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i>PASO 4: Adición de CALCIO (Punto Crítico)</h4>`;
            if(dCa) {
                stepsHtml += `<p class="text-[10px] text-red-600 mb-2 font-bold">Asegurar que el Fosfato está diluido y homogeneizado.</p>` + createStepLine(dCa);
            } else {
                stepsHtml += `<p class="pl-2 text-slate-500 italic font-medium"><i class="fa-regular fa-circle-check mr-1"></i>No se añade Calcio en esta mezcla.</p>`;
            }
            stepsHtml += `</div>`;

            // PASO 5: FINAL
            stepsHtml += `<div class="mb-1"><h4 class="font-bold text-blue-800 text-sm mb-1">PASO 5: Fase Final (Inspección + Lípidos)</h4>`;
            if(dLip) stepsHtml += createStepLine(dLip); if(dVit1) stepsHtml += createStepLine(dVit1); if(dVit2) stepsHtml += createStepLine(dVit2); if(dVit3) stepsHtml += createStepLine(dVit3); if(dVit4) stepsHtml += createStepLine(dVit4);
            stepsHtml += `</div>`;
            
            stepContainer.innerHTML = stepsHtml;
            stepContainer.innerHTML = stepsHtml;

            // Logística Final
            const volFinal = document.getElementById('elab-volumen').innerText;
            const osmFinal = document.getElementById('val-osmolaridad').innerText;
            const viaAdmin = document.getElementById('via-admin').value === 'central' ? 'CENTRAL' : 'PERIFÉRICA';
            
            document.getElementById('p-vol-final').innerText = volFinal;
            document.getElementById('p-osm-final').innerText = osmFinal + ' mOsm/L';
            document.getElementById('p-bolsa').innerText = document.getElementById('res-bolsa').value;
            document.getElementById('p-via').innerText = "VÍA " + viaAdmin;
            document.getElementById('p-fungibles').innerHTML = document.getElementById('res-fungibles').innerHTML.replace(/div/g, 'span class="block"');

            // --- B. GENERACIÓN DE ETIQUETAS ---
            const labelsContainer = document.getElementById('labels-page-content');
            
            // Caducidad
            const expDate = new Date();
            expDate.setDate(expDate.getDate() + 4);
            const expStr = expDate.toLocaleDateString();

            // Texto Aditivos
            let aditivosArr = [];
            if(dVit1) aditivosArr.push(`${dVit1.name.substring(0,15)}.. (${dVit1.vol}ml)`);
            if(dVit2) aditivosArr.push(`${dVit2.name.substring(0,15)}.. (${dVit2.vol}ml)`);
            if(dVit3) aditivosArr.push(`${dVit3.name.substring(0,15)}.. (${dVit3.vol}ml)`);
            if(dVit4) aditivosArr.push(`Tiamina 300mg (${dVit4.vol}ml)`);
            const aditivosStr = aditivosArr.length > 0 ? aditivosArr.join('<br>') : "Ninguno";

            // Plantilla HTML ETIQUETA (CON NOMBRE)
            const createLabelHTML = () => `
                <div class="label-report">
                    <div class="lbl-header"><div class="lbl-title">NUTRICIÓN PARENTERAL</div><div class="lbl-subtitle">Hospital / Servicio de Farmacia</div></div>
                    
                    <div style="text-align:center; border-bottom:1px solid #000; margin-bottom:4px; padding-bottom:2px;">
                        <span style="font-size:12pt; font-weight:bold; display:block;">${nombre}</span>
                    </div>

                    <div class="lbl-patient-row" style="display: flex; justify-content: center; width: 100%;">
                        <div style="margin: 0 15px;">NHC: ${nhc}</div>
                        <div style="margin: 0 15px;">Cama: ${cama}</div>
                        <div style="margin: 0 15px;">Fecha: ${fechaStr.split(' ')[0]}</div>
                    </div>
                    
                    <div style="display:flex; gap:5px; margin-bottom:8px;">
                         <div class="lbl-box-osm" style="flex:1"><span style="font-size:7pt; display:block;">VOLUMEN</span><span class="lbl-val-bold" style="font-size:11pt;">${volFinal}</span></div>
                         <div class="lbl-box-osm" style="flex:1"><span style="font-size:7pt; display:block;">KCAL</span><span class="lbl-val-bold" style="font-size:11pt;">${kcalTotal.toFixed(0)}</span></div>
                         <div class="lbl-box-osm" style="flex:1"><span style="font-size:7pt; display:block;">VIA</span><span class="lbl-via" style="color:${viaAdmin==='CENTRAL'?'#b91c1c':'#15803d'}">${viaAdmin}</span></div>
                    </div>
                    
                    <table class="lbl-data-table">
                        <tr><th width="40%">PROTEÍNAS (AA / N)</th><th width="30%">GLUCOSA</th><th width="30%">LÍPIDOS</th></tr>
                        <tr>
                            <td align="center" class="lbl-val-bold" style="font-size: 8pt;">
                                ${document.getElementById('val-prot').innerText} g / ${document.getElementById('val-n2').innerText} g N
                                <br><span style="font-size:6pt; font-weight:normal;">(Kcal no prot./g N: ${ratioStr})</span>
                            </td>
                            <td align="center" class="lbl-val-bold">${document.getElementById('val-hc').innerText} g</td>
                            <td align="center" class="lbl-val-bold">${document.getElementById('val-lip').innerText} g</td>
                        </tr>
                    </table>
                    
                    <table class="lbl-data-table">
                        <tr>
                            <th>Na+</th> <th>K+</th> <th>Cl-</th> <th>Acet</th> <th>Ca++</th> <th>Mg++</th> <th>P</th>
                        </tr>
                        <tr style="text-align:center;">
                            <td>${document.getElementById('input-sodio').value}</td>
                            <td>${document.getElementById('input-potasio').value}</td>
                            <td>${document.getElementById('input-cloro').value}</td>
                            <td>${document.getElementById('input-acetato').value}</td>
                            <td>${document.getElementById('input-calcio').value}</td>
                            <td>${document.getElementById('input-magnesio').value}</td>
                            <td>${document.getElementById('input-fosforo').value}</td>
                        </tr>
                        <tr style="text-align:center; font-size:6pt; color:#666;">
                            <td>mEq</td> <td>mEq</td> <td>mEq</td> <td>mEq</td> <td>mEq</td> <td>mEq</td> <td>mmol</td>
                        </tr>
                    </table>
                    
                    <table class="lbl-data-table" style="margin-bottom:0;">
                        <tr><th width="60%">ADITIVOS / VITAMINAS</th><th>OSMOLARIDAD</th></tr>
                        <tr><td valign="top" style="height:35px;">${aditivosStr}</td><td align="center" valign="middle"><span class="lbl-val-bold" style="font-size:10pt;">${osmFinal}</span><br><span style="font-size:7pt">mOsm/L</span></td></tr>
                    </table>
                    
                    <div class="lbl-footer">
                        <strong>Caducidad: ${expStr}</strong>. Conservar entre 2-8ºC protegido de la luz.<br>
                        Validado por: _____________________________
                    </div>
                </div>
            `;

            labelsContainer.innerHTML = createLabelHTML() + createLabelHTML();
            window.print();
        }

        // --- GESTOR VISUAL DE BASE DE DATOS (NUEVO) ---

        let currentConfigCategory = 'proteinas';

        // Definición de qué campos pedir para cada categoría
        const CONFIG_FIELDS = {
            proteinas: [
                { id: 'concentracion_aa', label: 'Conc. Aminoácidos (g/L)', type: 'number', req: true },
                { id: 'nitrogeno', label: 'Nitrógeno (g/L)', type: 'number', req: true },
                { id: 'sodio', label: 'Sodio (mmol/L)', type: 'number' }
            ],
            hidratos: [
                { id: 'concentracion_hc', label: 'Conc. Glucosa (g/L)', type: 'number', req: true },
                { id: 'kcal_l', label: 'Kcal/L', type: 'number' }
            ],
            lipidos: [
                { id: 'concentracion_lip', label: 'Conc. Lípidos (g/L)', type: 'number', req: true },
                { id: 'kcal_l', label: 'Kcal/L', type: 'number' },
                { id: 'sodio', label: 'Sodio (mmol/L)', type: 'number' }
            ],
            electrolitos: [
                { id: 'concentracion_sodio', label: 'Sodio (mEq/L)', type: 'number' },
                { id: 'concentracion_potasio', label: 'Potasio (mEq/L)', type: 'number' },
                { id: 'concentracion_cloro', label: 'Cloro (mEq/L)', type: 'number' },
                { id: 'concentracion_calcio_mEq', label: 'Calcio (mEq/L)', type: 'number' },
                { id: 'concentracion_magnesio', label: 'Magnesio (mEq/L)', type: 'number' },
                { id: 'concentracion_fosfato', label: 'Fosfato (mmol/L)', type: 'number' },
                { id: 'concentracion_acetato', label: 'Acetato (mEq/L)', type: 'number' },
                { id: 'concentracion_sulfato', label: 'Sulfato (mEq/L)', type: 'number' }
            ],
            vitaminas: [
                { id: 'volumen_envase', label: 'Volumen Envase (ml)', type: 'number' }
            ],
            bolsas: [
                { id: 'capacidad_ml', label: 'Capacidad (ml)', type: 'number', req: true }
            ],
            fungibles: [] // Solo nombre
        };

        // 1. Renderizar la vista de categoría
        function renderCategoryConfig(cat) {
            currentConfigCategory = cat;
            
            // Actualizar botones laterales
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-blue-600');
                btn.classList.add('text-slate-600');
            });
            document.getElementById(`cat-btn-${cat}`).classList.add('bg-blue-50', 'text-blue-600');
            document.getElementById(`cat-btn-${cat}`).classList.remove('text-slate-600');

            // Título
            document.getElementById('config-cat-title').innerText = 'Gestionar ' + cat.charAt(0).toUpperCase() + cat.slice(1);

            // Ocultar formulario si estaba abierto
            hideAddForm();

            // Renderizar Tabla
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';
            
            const items = materiasPrimas[cat] || {};
            
            if (Object.keys(items).length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-400">No hay productos en esta categoría.</td></tr>`;
                return;
            }

            for (const [key, item] of Object.entries(items)) {
                // Crear resumen de detalles
                let details = [];
                if(item.codigo_nacional) details.push(`CN: ${item.codigo_nacional}`);
                if(item.osmolaridad) details.push(`Osm: ${item.osmolaridad}`);
                // Añadir detalles específicos
                const fields = CONFIG_FIELDS[cat] || [];
                fields.forEach(f => {
                    if(item[f.id]) details.push(`${f.label.split('(')[0]}: ${item[f.id]}`);
                });

                tbody.innerHTML += `
                    <tr class="bg-white hover:bg-slate-50 transition">
                        <td class="px-6 py-4 font-medium text-slate-900">${item.nombre}</td>
                        <td class="px-6 py-4 text-xs text-slate-500">${details.join(' | ')}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="deleteItem('${cat}', '${key}')" class="text-red-600 hover:text-red-900 text-xs font-bold border border-red-100 hover:bg-red-50 px-2 py-1 rounded">
                                <i class="fa-solid fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // 2. Mostrar Formulario de Añadir
        function showAddForm() {
            const container = document.getElementById('add-item-form-container');
            const dynamicContainer = document.getElementById('dynamic-fields-container');
            const form = document.getElementById('add-item-form');
            
            form.reset(); // Limpiar inputs
            dynamicContainer.innerHTML = ''; // Limpiar dinámicos

            // Generar campos dinámicos según categoría
            const fields = CONFIG_FIELDS[currentConfigCategory] || [];
            
            if (fields.length === 0 && currentConfigCategory !== 'fungibles') {
                dynamicContainer.innerHTML = '<p class="text-xs text-slate-400 italic">Solo se requiere Nombre y CN.</p>';
            }

            fields.forEach(f => {
                dynamicContainer.innerHTML += `
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1">${f.label}</label>
                        <input type="${f.type}" id="dyn-${f.id}" ${f.req ? 'required' : ''} class="w-full border-slate-300 rounded p-2 text-sm bg-slate-50 focus:bg-white" placeholder="0">
                    </div>
                `;
            });

            container.classList.remove('hidden');
            document.getElementById('config-table-container').classList.add('opacity-50', 'pointer-events-none');
            // Scroll al formulario
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function hideAddForm() {
            document.getElementById('add-item-form-container').classList.add('hidden');
            document.getElementById('config-table-container').classList.remove('opacity-50', 'pointer-events-none');
        }

        // 3. GUARDAR NUEVO ITEM (Soluciona el bug de sobrescritura)
        function saveNewItem() {
            const name = document.getElementById('new-nombre').value;
            if (!name) return alert("El nombre es obligatorio");

            // Generar ID único (slug)
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Math.floor(Math.random() * 1000);

            // Objeto base
            const newItem = {
                nombre: name,
                codigo_nacional: parseInt(document.getElementById('new-cn').value) || 0,
                osmolaridad: parseFloat(document.getElementById('new-osm').value) || 0
            };

            // Recoger campos dinámicos
            const fields = CONFIG_FIELDS[currentConfigCategory] || [];
            fields.forEach(f => {
                const val = document.getElementById(`dyn-${f.id}`).value;
                if (val !== "") {
                    newItem[f.id] = parseFloat(val);
                }
            });

            // AÑADIR A LA LISTA EXISTENTE (Sin borrar lo anterior)
            if (!materiasPrimas[currentConfigCategory]) materiasPrimas[currentConfigCategory] = {};
            
            // Asignamos la nueva clave al objeto de esa categoría
            materiasPrimas[currentConfigCategory][id] = newItem;

            // Guardar en LocalStorage
            saveToLocalStorage();

            // Refrescar UI
            hideAddForm();
            renderCategoryConfig(currentConfigCategory);
            
            // Notificar éxito (opcional)
            // alert("Producto añadido correctamente. Recuerde recargar la página si quiere usarlo ahora.");
        }

        // 4. ELIMINAR ITEM
        function deleteItem(cat, key) {
            if(confirm("¿Estás seguro de eliminar este producto?")) {
                delete materiasPrimas[cat][key];
                saveToLocalStorage();
                renderCategoryConfig(cat);
            }
        }

        // Helper para guardar
        function saveToLocalStorage() {
            localStorage.setItem('nutricalc_db_v1', JSON.stringify(materiasPrimas));
            // Actualizar selectores (para que aparezca sin recargar F5, aunque F5 es más seguro)
            initRawMaterials(); 
        }

        function resetDatabaseToFactory() {
            if (confirm("¿Restaurar la base de datos original? Se perderán tus productos personalizados.")) {
                localStorage.removeItem('nutricalc_db_v1');
                location.reload();
            }
        }
        
    </script>
</body>
</html>
